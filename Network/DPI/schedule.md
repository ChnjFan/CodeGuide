# DPI 开发学习计划（6-8 个月进阶，从基础到工程实践）

该计划按 “基础理论→核心技术→工程实践→优化进阶” 逻辑推进，兼顾知识储备与实战能力，适合有一定编程基础（如 C/C++）的学习者。

## 第一阶段：基础理论铺垫（1-1.5 个月）

目标：掌握网络底层逻辑与 DPI 依赖的核心理论，建立技术认知框架。

1. **TCP/IP 协议栈深度学习**
   - 核心内容：重点突破 “链路层→网络层→传输层→应用层” 的分层解析逻辑，尤其掌握各层头部结构（如 IP 头的协议字段、TCP 头的端口 / 序列号、UDP 头的校验和）。
   - 学习资源：《TCP/IP 详解 卷 1：协议》（重点读第 3-5 章、第 17-19 章）、Wireshark 抓包分析（实操捕获 HTTP、TCP 握手包，拆解头部字段）。
   - 输出要求：能独立用 Wireshark 分析一个完整的 “浏览器访问网页” 流量包，标注各层头部关键字段含义。
2. **计算机网络核心概念强化**
   - 必学知识点：
     - 传输层：TCP 三次握手 / 四次挥手、滑动窗口、拥塞控制；UDP 的无连接特性与适用场景（如 DNS、视频流）。
     - 应用层：主流协议的 “表层特征 + 载荷结构”（如 HTTP 的请求行 / 响应头、HTTPS 的 TLS 握手流程、DNS 的查询 / 响应格式）。
   - 学习资源：B 站 “韩立刚 计算机网络” 课程（重点看传输层、应用层章节）、RFC 文档（HTTP 看 RFC2616，TLS 看 RFC5246）。

## 第二阶段：核心技术与工具掌握（1.5-2 个月）

目标：攻克 DPI 开发的核心技术（抓包、解析、特征匹配），熟练使用开发工具。

1. **网络数据包捕获技术**
   - 核心工具：Linux 环境下的`libpcap`（C 语言）、Windows 下的`WinPcap`（兼容 libpcap 接口）。
   - 学习内容：
     - 掌握 libpcap 的核心 API：`pcap_open_live`（打开网卡）、`pcap_compile`/`pcap_setfilter`（设置过滤规则）、`pcap_loop`（循环捕获数据包）。
     - 实战任务：编写一个简单的 “抓包工具”，能捕获指定网卡的 TCP/UDP 数据包，并打印源 IP、目的 IP、端口号。
   - 学习资源：libpcap 官方文档（https://www.tcpdump.org/manpages/pcap.3pcap.html）、《Linux 网络编程》（第 8 章 原始套接字与数据包捕获）。
2. **数据包解析技术**
   - 核心能力：按 TCP/IP 分层逻辑，从原始数据包中逐层剥离头部，提取应用层载荷。
   - 学习步骤：
     1. 基于 libpcap 捕获的原始数据（`const u_char *packet`），先解析以太网帧头（获取 IP 包起始位置）。
     2. 解析 IP 头（判断协议类型：TCP=6、UDP=17，获取 IP 头长度以定位传输层头部）。
     3. 解析 TCP/UDP 头（获取端口号，TCP 需判断是否为 “数据段”，排除纯 ACK 包）。
     4. 提取应用层载荷（TCP 需处理 “粘包” 问题，UDP 直接提取载荷）。
   - 实战任务：完善抓包工具，增加 “解析模块”，能输出 HTTP 请求的 “GET/POST” 方法、URL（需处理 TCP 粘包，仅提取完整 HTTP 请求行）。
3. **DPI 核心：协议特征匹配技术**
   - 核心方法：
     - 模式匹配：基于 “固定特征字段”（如 HTTP 的 “Host: ”、FTP 的 “USER ”），使用字符串查找（`strstr`）或高效算法（KMP、AC 自动机）。
     - 规则匹配：结合多维度特征（如端口范围 + 载荷特征，如 DNS 常用 53 端口 + 载荷首字节为 0x01（查询））。
   - 学习内容：
     - 理解 “协议特征库” 设计：为 HTTP、DNS、FTP 定义特征（如 HTTP 特征：载荷前 4 字节为 “GET ” 或 “POST”，且包含 “HTTP/1.”）。
     - 实战任务：在解析工具中增加 “特征匹配模块”，能识别 HTTP、DNS、FTP 三种协议，输出 “协议类型 + 关键信息”（如 DNS：“查询域名 =[www.baidu.com](https://www.baidu.com/)”）。

### 第三阶段：工程化开发实战（2-2.5 个月）

目标：将核心技术整合为完整 DPI 原型，解决工程化问题（性能、兼容性、多协议支持）。

1. **DPI 原型开发（核心任务）**
   - 开发环境：Linux（Ubuntu 20.04）、C/C++（GCC 编译器）、CMake（项目构建）、Git（版本控制）。
   - 原型功能模块：
     - 抓包模块：基于 libpcap，支持指定网卡、过滤规则（如仅捕获 TCP 80/443 端口流量）。
     - 解析模块：支持 TCP/UDP 数据包分层解析，处理 TCP 粘包（基于 “换行符” 或 “Content-Length” 判断 HTTP 请求完整性）。
     - 特征库模块：设计可扩展的特征库（用结构体 / 配置文件存储协议名、特征字段、端口范围），支持新增协议（如添加 HTTPS（TLS）识别：载荷前 2 字节为 0x1603（TLS 握手标识））。
     - 输出模块：将识别结果（时间戳、源 IP、目的 IP、协议类型、关键信息）打印到终端或写入日志文件。
   - 开发步骤：
     1. 用 CMake 搭建项目结构（src/（源码）、include/（头文件）、config/（特征库配置））。
     2. 分模块编码，每个模块编写单元测试（如解析模块测试：用预设的 HTTP 数据包二进制文件，验证是否能正确提取 URL）。
     3. 整合所有模块，测试端到端功能（如捕获 “访问百度” 的流量，能识别为 HTTP/HTTPS 协议，并输出域名）。
2. **工程化问题解决**
   - 关键问题 1：TCP 粘包 / 拆包处理
     - 解决方案：基于 “应用层协议边界”（如 HTTP 用 “\r\n\r\n” 标识请求头结束），或维护 TCP 会话（用 “源 IP + 目的 IP + 源端口 + 目的端口” 作为会话标识，缓存未完整解析的数据包）。
   - 关键问题 2：多线程并发抓包
     - 解决方案：用 “生产者 - 消费者模型”，一个线程抓包并将数据包放入队列，多个线程并行解析 + 特征匹配，提升处理性能（需注意线程安全，用互斥锁保护队列）。
   - 实战任务：优化原型，解决 TCP 粘包问题，并加入多线程处理，测试在 “100Mbps 流量” 下的识别准确率（需用 iperf 工具模拟流量）。

## 第四阶段：优化进阶与扩展（1-2 个月）

目标：提升 DPI 的性能、兼容性与功能覆盖，适配复杂场景。

1. **性能优化**
   - 优化方向：
     - 特征匹配算法：将`strstr`替换为 AC 自动机（多模式匹配效率更高，适合大量协议特征），学习 AC 自动机原理并基于开源库（如`libac`）集成。
     - 内存优化：使用内存池管理数据包缓存，避免频繁`malloc/free`；减少数据包拷贝（用`mmap`或零拷贝技术）。
   - 测试工具：用`tcpdump`生成大流量 pcap 文件，对比优化前后的 “每秒处理数据包数（PPS）”。
2. **复杂协议支持**
   - 重点突破：
     - 加密协议识别（HTTPS/TLS）：无需解密，基于 “TLS 握手包特征” 识别（如 SNI 字段（服务器名称指示），可提取域名；TLS 版本、加密套件），学习`openssl`库解析 TLS 握手包。
     - 动态端口协议（如 P2P、视频流）：结合 “行为特征”（如短时间内大量连接、数据包大小规律）辅助识别，而非仅依赖端口。
   - 实战任务：在原型中增加 HTTPS 识别，能输出 SNI 域名（如 “[https://www.taobao.com](https://www.taobao.com/)”）。
3. **行业场景适配**
   - 选择 1 个目标行业（如网络安全 / 运营商），针对性扩展功能：
     - 网络安全场景：增加 “恶意流量识别”（如匹配 “挖矿协议” 特征（如 XMRig 的 TCP 端口 + 特定载荷），输出告警）。
     - 运营商场景：增加 “流量统计”（按协议类型（HTTP/HTTPS/P2P）统计流量占比，生成简易报表）。

## 学习资源汇总

1. **书籍**：《TCP/IP 详解 卷 1》《Linux 高性能服务器编程》《网络安全编程实战》
2. **工具文档**：libpcap 官方文档、Wireshark 用户指南、AC 自动机开源库（如`https://github.com/liu888666/libac`）
3. **实战源码参考**：开源 DPI 项目（如`nDPI`（https://github.com/ntop/nDPI），学习其协议特征库设计与解析逻辑）
4. **在线课程**：B 站 “陈皓 网络编程实战”、Coursera“Computer Networking: Principles, Protocols and Practice”