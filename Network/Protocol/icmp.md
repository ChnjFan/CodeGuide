# ICMP 协议

ICMP（Internet Control Message Protocol）即互联网控制消息协议，依赖 IP 协议进行封装和发送，本身不提供 可靠传输。ping 和 traceroute 等工具使用 ICMP 协议通信。

[TOC]

## 协议报文

IPv4 报文协议字段值为 1 表示该报文携带 ICMPv4。

```bash
+0------7-------15---------------31
|  Type | Code  |    Checksum    |
+--------------------------------+
|          Message Body          |
|        (Variable length)       |
+--------------------------------+
```

- 类型：ICMP 报文类型，用于确定特定报文，例如 8 表示回显请求，0 表示回显应答，3 表示目标不可达。
- 代码：指定报文含义，对类型进行细分。例如 Type = 3 时，Code = 1 表示主机不可达，Code = 3 表示端口不可达。
- 校验和：验证 ICMP 报文完整性。

报文类型携带不同的消息数据：

- **差错报文**：包含触发差错的 IP 数据包头部和部分数据，帮助源端定位出错数据包。
- **查询报文**：信息采集和配置内容，例如 ping 命令发送默认 56 字节数据。

| 类型（Type） | 代码（Code） | 报文名称（中文 / 英文）              | 核心用途与典型场景                                           |
| ------------ | ------------ | ------------------------------------ | ------------------------------------------------------------ |
| **0**        | 0            | 回显应答 / Echo Reply                | 响应 Type=8 的 “回显请求”，是 “ping” 命令的应答包，确认目标主机可达。 |
| **8**        | 0            | 回显请求 / Echo Request              | “ping” 命令主动发送的请求包，携带自定义数据（如 56 字节测试数据），等待目标返回应答。 |
| **3**        | 0-15         | 目标不可达 / Destination Unreachable | 细分场景最多的差错类型，Code 值标识具体原因：- Code=1：**主机不可达**（IP 存在但主机未响应）；- Code=3：**端口不可达**（IP 可达但目标端口未开放，如访问未开启的 8080 端口）；- Code=5：**源路由失败**（数据包指定的源路由无效）。 |
| **11**       | 0 / 1        | 超时 / Time Exceeded                 | 两种核心场景：- Code=0：**TTL 超时**（IP 包的 TTL 减至 0，路由器丢弃并返回，是 “traceroute” 的核心原理）；- Code=1：**分片重组超时**（数据包分片后，未在规定时间内收全所有分片）。 |
| **12**       | 0 / 1        | 参数问题 / Parameter Problem         | 标识 IP 数据包头部格式错误：- Code=0：**头部字段错误**（如校验和无效、字段长度异常）；- Code=1：**缺少必要选项**（如 IP 包依赖的选项字段缺失）。 |
| **5**        | 0-3          | 重定向 / Redirect                    | 路由器告知源主机 “存在更优路由”：- Code=0：**网络重定向**（对整个网络的路由优化）；- Code=1：**主机重定向**（对特定主机的路由优化），常见于局域网网关调整场景。 |

## ICMP 差错报文

ICMP 差错报文用于当路由器或主机在处理 IP 数据包时遇到异常情况（如丢包、超时、格式错误），**被动向数据包的源端发送故障通知**，帮助源端定位问题、调整传输行为，是网络故障排查的重要依据。

差错报文是在 IP 层处理错误时触发，携带部分出错 IP 数据包的信息。

### 报文规则

为避免广播风暴，ICMP 差错报文生成存在限制：

- **不响应 ICMP 差错报文**：对收到的 ICMP 差错报文不再生成新的差错报文。
- **仅对 IP 单播包响应**：对广播地址或组播地址的数据报不生成 ICMP 差错报文，避免局域网内出现大量广播报文。
- **不响应其他 IP 分片**：只响应第一个 IP 分片，其他分片不响应。

### 常见报文

ICMP 报文通过类型和代码组合，表示具体的故障场景。

#### 目标不可达

当路由器或主机无法将 IP 数据报发送到目标地址时，会发送此报文（Type = 3）。

```bash
+0------7-------15---------------31
|  Type | Code  |    Checksum    |
+--------------------------------+
|              unused            |
+--------------------------------+
|        Internet Header         |
|          +64 bits of           |
|   Original Data Datagram       |
+--------------------------------+
```

- Unused（4 字节）：未使用必须填 0。
- 数据部分：IP首部+原始数据包的前8字节：
  - IP首部：如果IP首部没有选项字段时为20字节
  - 原始数据包的前8字节：UDP首部的8字节或者TCP首部的8字节。该数据是主机用来匹配消息。对于更高层协议的用户端口号，原始数据包的前64比特的这些数据会被重组。

UDP 接收一个数据报且对应目的端口号未被任何进程使用，UDP 会回应一个 ICMP 端口不可达报文。

```bash
fan@192 ~ % sudo tcpdump -i lo0 icmp -vvv -X -s 0
21:30:38.307459 IP (tos 0x0, ttl 64, id 62544, offset 0, flags [none], proto ICMP (1), length 56, bad cksum 0 (->8872)!)
    localhost > localhost: ICMP localhost udp port ndmp unreachable, length 36
	IP (tos 0x0, ttl 64, id 40036, offset 0, flags [none], proto UDP (17), length 33, bad cksum 0 (->e065)!)
    localhost.52588 > localhost.ndmp: [no cksum] UDP, length 5
	0x0000:  4500 0038 f450 0000 4001 0000 7f00 0001  E..8.P..@.......
	0x0010:  7f00 0001 0303 e8d8 0000 0000 4500 0021  ............E..!
	0x0020:  9c64 0000 4011 0000 7f00 0001 7f00 0001  .d..@...........
	0x0030:  cd6c 2710 000d 0000                      .l'.....
```

例如，抓包可以看到 UDP 返回类型和代码是 0303，表示端口不可达。

> TCP 在接收 SYN 报文后，如果端口无进程监听，则会回复 RST 报文断链，不会回复 ICMP 端口不可达。

#### 重定向报文

ICMP 重定向报文（Type = 5）包含主机针对 ICMP 差错报文指定目的地址应该采用的下一跳路由器 IP 地址，用来告知主机存在更优的路径，让主机后续发往特定目标的数据报直接发给更优路由器，减少网络转发跳数。

```bash
+0------7-------15---------------31
|  Type | Code  |    Checksum    |
+--------------------------------+
|    Gateway Internet Address    |
+--------------------------------+
|        Internet Header         |
|          +64 bits of           |
|   Original Data Datagram       |
+--------------------------------+
```

- 网关地址：重定向到最优下一跳路由器的 IP 地址。

ICMP 重定向只会修改主机的本地路由表，且只接受直连路由器发送的重定向报文，防止伪造的重定向报文攻击。

#### 超时报文

当数据包的 **TTL（生存时间）字段减至 0** 仍未到达目标，或数据包分片重组超时，路由器会丢弃该数据包，并向源发送 ICMP 超时报文（Type = 11），以反馈传输异常。

**traceroute 工具**

ICMP 超时报文的典型应用场景就是 `traceroute` 工具，用来确定发送者到目的地路径的路由器。

工作原理：

1. 发送 TTL 为 1 的数据报，第一个路由器 TTL 到期会返回 ICMP 超时报文。
2. 继续发送 TTL 值增加 1 的数据报，更远的路由器 TTL 到期返回 ICMP 超时报文。
3. 直到目的地路由器返回 ICMP 超时报文。

## ICMP 查询报文

ICMP 定义的查询报文类型大部分已经被 DHCP 等协议替代，目前广泛使用的是回显请求/应答报文（ping）和路由器发现报文（IPv6 RD）。

### 回显请求报文

ICMP 回显请求报文（Type = 8）用于触发目标设备返回应答报文（Type = 0），来判断网络设备的连通性、延迟和丢包率。

```bash
+0------7-------15---------------31
|  Type | Code  |    Checksum    |
+--------------------------------+
|   Identifier  | Sequence Number|
+--------------------------------+
|             Data               |
+--------------------------------+
```

- 标识符：发送端标识发送报文，例如将进程 ID 设置到标识符中。
- 序列号：发送端发送报文序列，每发送一个序列号加 1。

数据部分发送时写入当前系统时间，接收方应答时返回填写的时间，发送方通过发送时间和接收应答时间计算往返延时 RTT。

 





