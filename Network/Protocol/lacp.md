# LACP 协议

链路聚合控制协议（LACP）是在两台网络设备间动态协商，将多个物理端口捆绑成一个逻辑聚合组（LAG），实现带宽叠加和冗余备份。

[TOC]

## 以太网链路聚合

以太网链路聚合（Eth-Trunk）通过将多个物理口捆绑为一个逻辑接口，在不进行硬件升级条件下，增加链路带宽。

- **增加带宽**：链路聚合接口的最大带宽可以达到各成员接口带宽之和。
- **提高可靠性**：当某条活动链路出现故障时，流量可以切换到其他可用的成员链路上，从而提高链路聚合接口的可靠性。
- **负载分担**：在一个链路聚合组内，可以实现在各成员活动链路上的负载分担。

### 链路集合组

链路聚合组 LAG（Link Aggregation Group）是指将若干条以太链路捆绑在一起所形成的逻辑链路。

- 链路聚合接口：Eth-Trunk接口，LAG 唯一对应的逻辑接口，可以作为普通一条网接口使用。
- 成员接口：组成 Eth-Trunk 接口的物理接口。
- 成员链路：成员接口对应的链路。
- 活动接口：转发数据的成员接口，不转发数据的称为非活动接口。对应的链路是活动链路或非活动链路。

### 链路聚合模式

链路聚合模式分为手动模式和 LACP 模式。

- 手动模式：链路聚合、成员接口加入都由手动配置，所有活动链路都参与数据转发，平均分担流量。
- LACP 模式：链路动态聚合和解聚合，聚合链路形成后，LACP 负责维护链路状态，结合条件发生变化后，自动调整链路聚合。

## LACP 工作原理

LACP 通过链路聚合控制协议数据单元 LACPDU 与对端交互信息，报文中包含设备的系统优先级、MAC 地址、接口优先、接口号和操作 Key 等信息。

### 报文格式

LACP 报文封装在以太网帧中传输，整体结构为：**以太网帧头 + LACPDU 载荷 + FCS（帧校验序列）**。

- 目的 MAC 地址：`01-80-C2-00-00-02`（链路聚合控制协议专用组播地址）。
- 源 MAC 地址：发送端设备端口 MAC 地址。
- 协议类型：0x8809

### 链路聚合建立

1. **协商建立阶段**

两端设备创建链路聚合并配置 LACP 模式后，向链路聚合中加入成员接口就会启动 LACP 协议，两端互发 LACPDU 报文。

报文包含本地设备信息（系统优先级和系统 MAC）、端口信息（端口优先级和端口号）、链路状态等。

对端接收报文后，验证链路配置一致性，筛选出符合条件的成员链路。

2. **聚合组确定阶段**

两端通过报文交互，选举主动端：收到对端的报文后查看系统优先级，如果对端的系统优先级高于本端，则确定对端为 LACP 主动端。如果系统优先级相同，MAC 地址小的一端为 LACP 主动端。

选择主动端后，两端都以主动端的接口优先级选择活动接口，接口优先级相同时选择接口编号小的活动接口，组成链路聚合组。

3. **数据转发阶段**

