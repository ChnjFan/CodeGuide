# ARP 协议

ARP（Address Resolution Protocol）地址解析协议是将 IP 地址解析成 MAC 地址的协议，让数据能在局域网内精准找到目标设备。

[TOC]

## 协议报文

ARP 报文封装在链路层帧中，不包含帧头总长度固定为 28 字节。

```bash
+0--------------7--------------15----------------23----------------31
|                Ethernet Address of Destination(0-47)              |
+                                  +--------------------------------|
|                                  |                                |
+----------------------------------+                                |
|                Ethernet Address of Sender(0-47)                   |
+----------------------------------|--------------------------------|
|             Frame Type           |           Hardware Type        |
+----------------------------------|----------------|---------------|
|           Protocol Type          | Hardware Length|Protocol Length|
+----------------------------------|--------------------------------|
|              OP                  |                                |
+----------------------------------+                                |
|                Ethernet Address of Sender(0-47)                   |
+-------------------------------------------------------------------|
|                         IP Address of Sender                      |
+-------------------------------------------------------------------|
|                Ethernet Address of Destination(0-47)              |
+                                  +--------------------------------|
|                                  | IP Address of Destination(0-15)|
+----------------------------------|--------------------------------|
| IP Address of Destination(16-31) |
+----------------------------------|
```

- 目的 MAC 地址（6 字节）：ARP 请求报文为广播报文，值为 0xFFFFFFFFFFFF。
- 源 MAC 地址（6 字节）：请求设备 MAC 地址。
- 帧类型（2 字节）：ARP 请求和应答值为 0x0806。
- 硬件类型（2 字节）：以太网值为0x0001。
- 协议类型（2 字节）：IPv4 值为 0x0800，IPv6 使用 NDP 协议，不依赖 ARP。
- 硬件地址长度（1 字节）：硬件类型以太网 MAC 地址长度 6 字节。
- 协议地址长度（1 字节）：IPv4 地址长度 4 字节。
- 操作码（2 字节）：ARP 请求 0x0001，ARP 应答 0x0002。
- 发送方 MAC 地址（6 字节）：发送方的 MAC 地址，与源 MAC 地址相同。
- 发送方 IP 地址（4 字节）：发送方的 IP 地址。
- 接收方 MAC 地址（6 字节）：请求报文为全 0，应答报文填写接收方 IP 地址对应设备的 MAC 地址。
- 接收方 IP 地址（4 字节）：接收方的 IP 地址，请求和应答报文都需要填写。

## 地址解析

ARP 协议的主要功能是地址解析，通过广播请求和单播响应完成 IP 到 MAC 映射。

- 作用范围：仅在**同一局域网**内生效，跨网段通信时，ARP 解析的是网关的 MAC 地址。
- 触发条件：设备向目标 IP 发送数据，本地 ARP 缓存中无对应的 MAC 地址。

### ARP 缓存

ARP 缓存使用地址解析为每个接口唯一从 IP 地址到 MAC 地址的映射，避免重复发起 ARP 请求。

查看 ARP 缓存方式：

```bash
fan@192 ~ % arp -n -a
? (192.168.5.1) at e4:4e:12:95:90:19 on en1 ifscope [ethernet]
? (192.168.5.2) at 12:23:c9:a5:34:df on en1 ifscope [ethernet]
? (192.168.5.3) at ba:4d:99:e9:d9:45 on en1 ifscope [ethernet]
```

ARP 缓存条目类型：

- 动态条目：ARP 请求自动获取，超时后自动删除。
- 静态条目：手动配置，默认无超时。

### ARP 请求报文

地址解析通过发送 ARP 请求广播报文学习目标 IP 地址对应的 MAC 地址。

- 广播报文：链路层数据帧的目标 MAC 地址为 0xFFFFFFFFFFFF。
- 接收方的 MAC 地址为  00:00:00:00:00:00。

局域网内所有设备都会接收到广播帧，检查接收方 IP 地址后，发现是自己的 IP 才会处理并发送 ARP 响应报文。

### ARP 应答报文

应答报文以单播方式发送给请求主机，链路层数据帧的目标 MAC 地址为请求方 MAC 地址。

将自身的 MAC 地址和 IP 地址填写到发送方地址中，请求方接收到应答报文后，更新自身 ARP 缓存表中。

## 地址冲突检测

IP 地址是局域网设备的唯一逻辑身份，如果两台设备 IP 地址冲突可能造成网络通信中断、数据丢失等问题。

ARP 协议将 IP 地址解析 MAC 地址的特性，适用于探测局域网中某个 IP 地址是否被其他设备占用。

### 免费 ARP

免费 ARP 是一种特殊 ARP 请求报文，通过通告自己的 IP、MAC 地址来寻找是否存在设备已使用自身的 IP 地址。

**免费 ARP 报文格式**：

- 发送方 IP 地址和目的 IP 地址相同，均为自身的 IP 地址。
- 链路层数据帧的目的 MAC 地址为广播地址。

**免费 ARP 应用场景**：

- 检测 IP 地址冲突：发送携带自身 IP 地址的 ARP 请求广播报文，如果没有接收到应答报文，说明当前网段不存在 IP 地址冲突的设备。
- 更新 ARP 缓存：当前设备 MAC 地址发送变化，或 VRRP 和集群技术场景中的主设备故障后，备设备接管，发送免费 ARP 报文通告网络中其他设备更新 ARP 缓存表。

### ARP 探测

ARP 探测报文是用于主动验证 IP 地址可用性的特殊报文，通过 DHCP 获取 IP 地址之后发送广播报文，探测是有存在设备已经占用该 IP 地址，避免 IP 地址冲突。

**ARP 探测报文格式**：

- 发送方 IP 地址为 0.0.0.0，因为 IP 地址还未设置。
- 接收方 IP 地址填写待探测的 IP 地址。

如果接收到该 IP 已经被占用的应答报文，该设备无法再使用该 IP 地址，并向 DHCP 服务器发送 DHCP Decline 报文请求重新分配 IP 地址。

**ARP 探测报文与免费 ARP 的区别**：

| 对比维度             | ARP 探测报文（ARP Probe）                               | 免费 ARP（Gratuitous ARP）                                   |
| -------------------- | ------------------------------------------------------- | ------------------------------------------------------------ |
| **核心目的**         | 预验证：确认 “待使用的 IP 是否被占用”（IP 未归属时）    | 后验证：确认 “已配置的 IP 是否冲突”（IP 已归属时）           |
| **发送端 IP（SPA）** | `0.0.0.0`（未确认 IP 归属，暂用无效 IP）                | 自身已配置的 IP（如 `192.168.1.10`）                         |
| **目标端 IP（TPA）** | 待探测的 IP（如 `192.168.1.10`）                        | 自身已配置的 IP（与 SPA 相同，如 `192.168.1.10`）            |
| **触发时机**         | 1. DHCP 客户端收到 `DHCP Offer` 后2. 手动配置静态 IP 前 | 1. 设备启动 / 重启后2. IP 地址变更后3. 定期维护（如每小时一次） |
| **典型场景**         | DHCP 分配 IP 的 “预检查”，避免占用已用 IP               | 设备启动后确认 IP 唯一性，或更新其他设备的 ARP 缓存          |

> ARP 探测报文是 “**先用探测确认可用，再用 IP**”；免费 ARP 是 “**先配置 IP，再用探测确认无冲突**”。

## ARP 代理

代理 ARP 是网关或路由器提供的 ARP 代理服务，路由器代替目标设备响应 ARP 请求，请求发送方误以为响应的是目标主机，实现无需配置网关即可跨网段通信。

应用场景：

- 子网迁移：当网络从一个子网迁移到另一个子网，可临时启用代理 ARP 让新旧子网主机互通，减少迁移中断。
- 部分旧系统无法进行子网划分，通过代理 ARP 实现通信。

代理 ARP 会导致路由器有回应大量跨子网 ARP 请求，占用网络带宽，攻击者可伪造代理 ARP 应答实施 ARP 欺骗。

















