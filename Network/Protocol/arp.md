# ARP 协议

ARP（Address Resolution Protocol）地址解析协议是将 IP 地址解析成 MAC 地址的协议，让数据能在局域网内精准找到目标设备。

[TOC]

## 协议报文

ARP 报文封装在链路层帧中，不包含帧头总长度固定为 28 字节。

```bash
+0--------------7--------------15----------------23----------------31
|                Ethernet Address of Destination(0-47)              |
+                                  +--------------------------------|
|                                  |                                |
+----------------------------------+                                |
|                Ethernet Address of Sender(0-47)                   |
+----------------------------------|--------------------------------|
|             Frame Type           |           Hardware Type        |
+----------------------------------|----------------|---------------|
|           Protocol Type          | Hardware Length|Protocol Length|
+----------------------------------|--------------------------------|
|              OP                  |                                |
+----------------------------------+                                |
|                Ethernet Address of Sender(0-47)                   |
+-------------------------------------------------------------------|
|                         IP Address of Sender                      |
+-------------------------------------------------------------------|
|                Ethernet Address of Destination(0-47)              |
+                                  +--------------------------------|
|                                  | IP Address of Destination(0-15)|
+----------------------------------|--------------------------------|
| IP Address of Destination(16-31) |
+----------------------------------|
```

- 目的 MAC 地址（6 字节）：ARP 请求报文为广播报文，值为 0xFFFFFFFFFFFF。
- 源 MAC 地址（6 字节）：请求设备 MAC 地址。
- 帧类型（2 字节）：ARP 请求和应答值为 0x0806。
- 硬件类型（2 字节）：以太网值为0x0001。
- 协议类型（2 字节）：IPv4 值为 0x0800，IPv6 使用 NDP 协议，不依赖 ARP。
- 硬件地址长度（1 字节）：硬件类型以太网 MAC 地址长度 6 字节。
- 协议地址长度（1 字节）：IPv4 地址长度 4 字节。
- 操作码（2 字节）：ARP 请求 0x0001，ARP 应答 0x0002。
- 发送方硬件地址（6 字节）：发送方的 MAC 地址，与源 MAC 地址相同。
- 发送方 IP 地址（4 字节）：发送方的 IP 地址。
- 接收方 MAC 地址（6 字节）：请求报文为全 0，应答报文填写接收方 IP 地址对应设备的 MAC 地址。
- 接收方 IP 地址（4 字节）：接收方的 IP 地址，请求和应答报文都需要填写。

## 地址解析

ARP 协议的主要功能是地址解析，通过广播请求和单播响应完成 IP 到 MAC 映射。

- 作用范围：仅在**同一局域网**内生效，跨网段通信时，ARP 解析的是网关的 MAC 地址。
- 触发条件：设备向目标 IP 发送数据，本地 ARP 缓存中无对应的 MAC 地址。

### ARP 缓存

ARP 缓存使用地址解析为每个接口唯一从 IP 地址到 MAC 地址的映射，避免重复发起 ARP 请求。

查看 ARP 缓存方式：

```bash
fan@192 ~ % arp -n -a
? (192.168.5.1) at e4:4e:12:95:90:19 on en1 ifscope [ethernet]
? (192.168.5.2) at 12:23:c9:a5:34:df on en1 ifscope [ethernet]
? (192.168.5.3) at ba:4d:99:e9:d9:45 on en1 ifscope [ethernet]
```

ARP 缓存条目类型：

- 动态条目：ARP 请求自动获取，超时后自动删除。
- 静态条目：手动配置，默认无超时。

### ARP 请求报文

地址解析通过发送 ARP 请求广播报文学习目标 IP 地址对应的 MAC 地址。

- 广播报文：二层数据帧的目标 MAC 地址为 0xFFFFFFFFFFFF。
- 接收方的 MAC 地址为  00:00:00:00:00:00。

局域网内所有设备都会接收到广播帧，检查接收方 IP 地址后，发现是自己的 IP 才会处理并发送 ARP 响应报文。

### ARP 应答报文

应答报文以单播方式发送给请求主机。

## 地址冲突检查

## ARP 代理

代理 ARP 是网关或路由器提供的 ARP 代理服务，路由器代替目标设备响应 ARP 请求，请求发送方误以为响应的是目标主机，实现无需配置网关即可跨网段通信。

## ARP 双发

















