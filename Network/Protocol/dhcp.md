# DHCP 协议

DHCP（Dynamic Host Configuration Protocol，动态主机配置协议）协议是用于**自动分配网络配置参数**的应用层协议。

[TOC]

## 核心特性

DHCP 协议的核心功能是为局域网内的终端设备（如 PC、手机、服务器）动态分配 IP 地址、子网掩码、网关、DNS 服务器等网络参数，避免手动配置的繁琐与错误，同时实现 IP 地址的高效复用。

DHCP 是客户端/服务器协议：

- DHCP 服务器：端口号 67，负责管理 IP 地址池，存储网络配置参数，响应终端的地址请求并分配资源。
- DHCP 客户端：端口号 68，发送 DHCP 报文向服务器请求网络配置。
- IP Pool：预先分配的一个连续的 IP 地址范围。
- 租约：DHCP 服务器分配给客户端的 IP 地址存在使用期限。

## 报文格式

DHCP 消息格式定义采用扩展 BOOTP 以保持协议兼容性，消息格式包括一个固定长度的初始部分和一个可变长度的选项字段。

```bash
0         7            15        23       31
+------------------------------------------+
|  Op(1)  |  Htype(1)  | Hlen(1) | Hops(1) |
+------------------------------------------|
|                    Xid(4)                |
+------------------------------------------|
|        Secs(2)      |      Flags(2)      |
+------------------------------------------|
|                 Ciaddr(4)                |
+------------------------------------------|
|                 Yiaddr(4)                |
+------------------------------------------|
|                 Siaddr(4)                |
+------------------------------------------|
|                 Giaddr(4)                |
+------------------------------------------+
|                 Chaddr(16)               |
+------------------------------------------+
|                 Sname(64)                |
+------------------------------------------|
|                 File(128)                |
+------------------------------------------+
|           Options(variable)              |
+------------------------------------------+
```

- Op 操作字段：1 为请求报文，2 为应答报文。
- Htype 字段表示硬件类型，1 表示以太网。
- Hlen 字段硬件地址长度，MAC 地址为 6 字节。
- Hops 字段保存消息传输进过 DHCP 中继的数目，客户端设置为 0。
- Xid 字段表示事务 ID，客户端设置一个随机数并由服务端返回，匹配应答和请求。
- Secs 字段表示客户端从开始获取地址或地址续租更新后所用的时间，单位是秒。
- Flags 只有最高位使用，0 表示客户端请求服务端以单播形式发送响应报文，1 表示服务端以广播形式发送。
- Ciaddr 客户端的IPv4地址。只有客户端是Bound、Renew、Rebinding状态，并且能响应ARP请求时，才能被填充，否则为 0。
- Yiaddr 表示服务器分配的 IP 地址。
- Siaddr 表明 DHCP 协议流程的下一个阶段要使用的服务器的 IPv4 地址。
- Giaddr 表示第一个DHCP中继的IPv4地址。客户端和服务端不在同一网段时，第一个 DHCP 中继在将 DHCP 请求转发给服务器时填写。服务器根据该地址网段分配合适的地址。
- Chaddr 字段表示客户端的MAC地址。
- Sname 字段表示客户端获取配置信息的服务器名字。
- File 字段表示客户端的启动配置文件名。
- Options 字段表示DHCP的选项字段，至少为312字节，格式为"代码+长度+数据"。

## DHCP 协议操作

DHCP 客户端基于 UDP 协议，与服务器进行四次交互（DORA 过程，Discover → Offer → Request → Acknowledge）获取 IP 地址并完成配置。

### DHCP Discover

客户端设备启动或接入网络后，未配置任何 IP 地址，需要通过广播报文寻找网络中的 DHCP 服务器获取配置。

- Ciaddr：0.0.0.0，此时客户端未配置 IP 地址。
- 目的 IP 地址 255.255.255.255 发送广播报文寻找 DHCP 服务器。
- 随机生成事务 ID（Xid）用于匹配响应报文。
- 选项字段 Type = 53，Value = 1 标识 Discover 报文。

若网段内存在多个 DHCP 服务器，所有服务器接收到报文后都会回复。

### DHCP Offer

DHCP 服务器接收到 Discover 报文后，向局域网内所有设备发送广播报文，并附带完整的网络配置等待客户端确认。

- Yiaddr 字段填写分配的 IP 地址。
- 选项字段 Type = 53，Value = 2 标识 Offer 报文。
- 选项字段 Type = 51 标识 IP 租用期，单位为秒，客户端需要在到期前续租。
- 选项中还包括子网掩码（Type = 1）、网关 IP 地址（Type = 3）、DNS 服务器地址（Type = 6）。

⚠️注意：DHCP 服务端向客户端发送 Offer 报文前，需要执行 ARP 探测来确保分配的 IP 地址没有被其他设备占用，避免 IP 冲突。

DHCP 服务端发送完 ARP 探测报文后，会启动探测超时定时器，根据是否收到 ARP 应答处理。

- 超时未收到应答：将该 IP 设置为待分配状态，构造 DHCP Offer 报文发给客户端。
- 超时前收到应答：当前 IP 标记为“不可用”，从地址池重新选择一个未分配 IP，再次发送 ARP 探测报文。

如果地址池中的所有 IP 地址均被探测已占用，服务端不会发送 DHCP Offer 报文，客户端持续发送 DHCP Discover 直到获取到可用的 IP 地址。

### DHCP Request

DHCP 客户端决定接收服务器发送的 Offer 报文，通过广播 DHCP Request 报文告知所有服务器选择的 IP 地址。

IP 地址租期过半后，客户端也会发送 DHCP Request 报文进行续租。

- Ciaddr 字段首次请求时填写 0.0.0.0，续租时填写正在使用的 IP 地址。
- Yiaddr 字段填写 0.0.0.0，该字段只能服务端填写。
- Siaddr 字段填写选择的 DHCP 服务器 IP 地址。
- 选项字段 Type = 53，Value = 3 标识 Request 报文。
- 选项字段 Type = 54 标识客户端选择的 DHCP 服务器 IP 地址。
- 选项字段 Type = 50 标识分配的 IP 地址。

### DHCP ACK

DHCP 服务端接收到 Request 报文后，确认 IP 地址仍可用后发送 DHCP ACK 报文，客户端收到后正式配置 IP 地址使用网络。

DHCP ACK 报文除了包含客户端网络参数外，明确了 IP 地址的租用期限。

- Yiaddr 字段填写分配的 IP 地址。
- Siaddr 字段填写 DHCP 服务器 IP 地址，用于客户端续租时通信。
- 选项字段 Type = 53，Value = 5 标识 ACK 报文。
- 选项字段 Type = 51 标识 IP 地址的租用时间。

## DHCP 中继

