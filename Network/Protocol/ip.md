# Internet 协议

IP（Internet Protocol，网际协议）是 TCP/IP 协议族的核心协议之一，位于网络层，负责在不同网络之间传递数据报。

[TOC]

## 地址结构

IP 地址用来在互联网中唯一标识一台设备的网卡，用于在 TCP/IP 网络中定位设备并实现数据包路由。

- **网络定位**：通过 IP 地址确定数据包的 “源设备” 和 “目标设备” 所在的网络位置；
- **路由转发**：路由器通过 IP 地址判断数据包的转发路径，确保数据从源到目标的传递。

### IPv4 地址结构

IPv4 地址长度 32 位（4 字节），采用点分十进制表示。32 位二进制数被平均分为 4 段（每段 8 位，即 1 字节），每段将二进制转换为十进制（取值范围 0-255），段之间用 “.” 分隔，例如：

- 二进制原始形式：`11000000.10101000.00000001.00000001`
- 点分十进制形式：`192.168.1.1`（常见的家庭路由器网关地址）

#### 地址分类

早期为了区分不同规模的网络，按照网络位+主机位划分为 A/B/C/D/E 五类，其中 A/B/C 类称为主类网络，D 类用于组播寻址。

主类网络一部分用于私有地址，是局域网内部使用的 IP 地址，不能在互联网上使用。

- A 类地址：`0.0.0.0 ~ 127.255.255.255`，前 8 位网络位标识 `0`。私有地址 `10.0.0.0 ~ 10.255.255.255`。
- B 类地址：`128.0.0.0 ~ 191.255.255.255`，前 16 位网络位标识 `10`。私有地址 `172.16.0.0 ~ 172.31.255.255`。
- C 类地址：`192.0.0.0 ~ 223.255.255.255`，前 24 位网络位标识 `110`。私有地址 `192.168.1.0 ~ 192.168.255.255`。
- D 类地址：`224.0.0.0 ~ 239.255.255.255`，不标识网络，网络位标识 `1110`，用于组播寻址。
- E 类地址：`240.0.0.0 ~ 255.255.255.255`，不标识网络，网络位标识 `11101`，保留地址。

特殊场景：

- 网络地址：主机位全为 0 的地址，用于标识整个网络，不可分配给设备，如 192.168.1.0。
- 广播地址：主机位全为 1 的地址，用来向子网所有设备发送数据。
- 私有地址：仅在局域网内使用，通过 NAT 转换为公网地址。
- 组播地址：D 类地址（1110，224.0.0.0～239.255.255.255）。
  - ASM，任意源组播，接收端进指定组播地址，可接受任意源发送该组的组播数据。
  - SSM，源特定组播，接收端绑定“源 IP + 组播组地址”，仅接收特定源发送的组播数据。
  - 本地链路组播地址：224.0.0.0~224.0.0.255（所有主机 224.0.0.1，所有路由器 224.0.0.2）。

#### 无类别域间路由 CIDR

CIDR 是一种灵活 IP 地址分配和路由聚合方法，允许根据动态分配子网掩码位数，解决主类网地址浪费、路由表膨胀问题。

格式：IP 地址/前缀长度。

- 子网划分：根据前缀长度切分网络位和主机位，将传统主类网划分为多个子网。
- 路由聚合：将多个连续子网，按共同前缀合并为一个大的聚合路由。例如 192.168.0.0/24、192.168.1.0/24、192.168.2.0/24、192.168.3.0/24 前 22 位相同，可聚合为 192.168.0.0/22。


### IPv6 地址结构

IPv6 地址长度 128 位（16 字节），分为 8 段（每段 16 位，即 2 字节），每段将二进制转换为**4 位十六进制数**（取值 0000-FFFF），段之间用 “:” 分隔，例如：

- 冒分十六进制形式：`2001:0000:0000:0000:0000:0000:0000:0001`（这是 IETF 的测试地址，可简化为`2001::1`）。
- 简化表示：省略每组前导 0，用双冒号“::”代替全零组。双冒号不能重复表示，例如 `2001::1:0:0:0:1`。

IPv6 地址采用 **“网络前缀 + 子网 ID + 接口 ID”** 的三级结构：

- **网络前缀**：表示全球唯一的网络区块。
- **子网 ID**：标识不同的子网。
- **接口 ID**：表示子网内的具体设备接口。

#### 地址分类

一个接口可以有多个不同类型或不同范围的 IPv6 地址，包括单播地址、任播地址和组播地址。

**单播地址**

IPv6 单播地址标识了一个接口，由于每个接口属于一个节点，每个接口的单播地址都可以标识这个节点。

- 未指定地址：`::/128` 表示接口还没有配置 IP 地址。
- 环回地址：`::/128` 环回与 IPv4 中的 127.0.0.1 作用相同，用于设备给自己发报文。
- 链路本地地址：前缀为 fe80::/10，用于统一网络下设备的邻居发现、自动地址配置等，该地址数据不会转发到其他链路。
- 全球单播地址：前缀为 2000::/3，类似于 IPv4 公网地址用于与外部网络通信，允许路由前缀聚合。
  - 全球路由前缀（Global routing prefix）、子网ID（Subnet ID）和接口标识（Interface ID）组成。

- 本地单播地址：私有网络内部通信。

**组播地址**

IPv6 的组播与 IPv4 相同，用来标识一组接口，一般这些接口属于不同的节点。发往组播地址的报文被组播地址标识的所有接口接收。详细介绍在 [组播基础](./multicast.md)。

IPv6组播地址由前缀，标志（Flag）字段、范围（Scope）字段以及组播组ID（Group ID）4个部分组成：

- 前缀 ff00::/8 为组播地址，后 112 为保存组号。
- 组播地址第 2 字节包含 4 位标志字段和 4 位范围 ID 字段。
- 组播组 ID：后 112 位标识组播组。

**任播地址**

任播地址标识一组网络接口，目标地址是任播地址的数据包将发送给其中路由意义上最近的一个网络接口，用来在给多个主机或者节点提供相同服务时提供冗余功能和负载分担功能。

## 报文结构

IP 提供一种尽力而为、无连接的数据报交付服务。

- 尽力而为：不能保证 IP 数据报能成功到达目的地。
- 无链接：不维护网络中数据报相关的链接状态信息。
- 面向数据报：数据以数据包为单位传输，每个数据包包含目的和源地址，可独立路由。

⚠️注意：每个数据报独立路由，就可能存在乱序到达的问题。

### IPv4 数据报结构

IPv4 头部固定长度为 20 字节，选项字段长度不固定。

```bash
   0                               15 16                            31
   +----------------+-----------+----+-------------------------------+
   |  Version | IHL |     DS    |ECN |         Total Length          |
   +----------+-----+-----------+----+-------------------------------+
   |         Identification          |Flags|    Fragment Offset      |
   +----------------+----------------+-------------------------------+
   |        TTL     |    Protocol    |       Header Checksum         |
   +----------------+----------------+-------------------------------+
   |                          Source IP Address                      |
   +-----------------------------------------------------------------+
   |                        Destination IP Address                   |
   +-----------------------------------------------------------------+
   |                               Options                           |
   +-----------------------------------------------------------------+
   |                                 Data                            |
   +-----------------------------------------------------------------+
```

- 版本号（4 位）：IPv4 为 4，IPv6 为 6。
- 头部长度（4 位）：最大 60 字节。
- 服务类型：前 6 位为服务字段提供不同类型服务，后 2 位是显式拥塞通知字段。
- 总长度：IPv4 数据报总长度，最大 65535 字节。
- 标识符：分片计数，每发送一个数据报计数加 1。
- 标志（3 位）：最高位保留。
  - 中间位（DF 位）表示对分组是否进行分片（0-分片，1-不能分片）
  - 最低位（MF 位）表示分组的数据报结束（0-结束，1-未结束）。

- 分片偏移：分片在原分组的相对位置。
- TTL：数据报经过路由器数量的上限。
- 协议：数据报携带数据类型，UDP=17，TCP=6。
- 头部校验和：仅计算 IPv4 头部，每经过的设备都要计算校验。
- 选项：用来支持排错、测量以及安全等措施。在必要的时候插入值为0的填充字节。

### IPv6 数据报结构

IPv6 报文结构在设计上相比 IPv4 更加简洁高效，头部固定大小 40 字节，有效载荷包括**扩展首部（可选）**和**上层协议数据**。

```bash
    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |Version| Traffic Class |              Flow Label               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |         Payload Length        |  Next Header  |   Hop Limit   |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   +                         Source Address                        +
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   +                      Destination Address                      +
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                      Extension Headers                        |
```

- 版本号（4 位）：IPv4 为 4，IPv6 为 6。
- 流量类别（8 位）：区分报文优先级和 QoS，支持流量调度。
- 流标签（20 位）：标识 IP 数据包的一个流，路由器基于同一流的数据报进行相同处理。
- 有效载荷长度（16 位）：固定头部之后的数据长度，包含扩展报头。
- 下一报头（8 位）：扩展首部的类型，没有则标识上层协议（TCP=6，UDP=17，ICMPv6=58）。
- 跳数限制（8 位）：类似 TTL，没经过一个路由器减 1。
- 源地址目的地址：分别 128 位 IPv6 地址，表示发送方和接收方。
- 扩展首部：IPv6 取消了 IPv4 首部中的可选字段，仅在需要特定功能时添加扩展首部，由接收方处理，路由器不处理扩展首部。

## IP 路由

IP 路由是网络设备接收一个 IP 数据包后，根据数据包的**目的 IP 地址**和设备自身的**路由表**，将数据包从一个网络接口转发到另一个网络接口，最终实现数据包从源主机到目标主机的跨网络传输过程。

### 路由表

路由表存储指向特定目的网络地址的路径信息，表中每个条目是一条路由，每条路由对应一个网络中的目的地。

路由表由 IP 路由协议维护，包括 [BGP](./bgp.md)、[IS-IS](./isis.md) 和 [OSPF](./ospf.md) 等协议。

#### 路由表字段

Linux 使用 `route -n` 查看路由表：

```bash
root@iZf8z4o3lbylu7kddpzwa1Z:~# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         172.31.159.253  0.0.0.0         UG    100    0        0 eth0
```

- **Destination**：目的网络地址，`0.0.0.0/0`表示默认路由。
- **Gateway**：下一跳IP地址，数据报需要转发到的下一个网络设备接口 IP，`0.0.0.0`表示直连网络。
- **Genmask**：目的网络的子网掩码。
- **Iface**：出接口，数据报从设备的哪个物理接口或逻辑接口发送出去。
- **Metric**：路由度量值，存在多条到达同一目的网络路由时，选择 Metric 最小的路由，有路由协议计算。
- **Flags**：路由标记，U 表示路由可用，G 表示需要经过网关，H 表示目的是单台主机。

#### 路由条目

- 直连路由：路由器本地接口所在网段，通过链路层发现接口处于活动状态就会将该网段路由信息写入路由表。
- 静态路由：网管配置的路由，适合拓扑结构简单稳定的网络，无法自动适应网络拓扑变化。
- 动态路由：动态路由协议发现的路由，自动适应网络拓扑变化。
  - 内部网关协议 IGP：在一个自治系统内部运行，[RIP 协议](./rip.md)、[OSPF 协议](./ospf.md)、[IS-IS 协议](./isis.md)。
  - 外部网关协议 EGP：运行在不同自治系统之间，[BGP 协议](./bgp.md)。


除本地路由表外，各路由协议维护自己的协议路由表，存放协议发现的路由信息，路由协议也可引入其他协议生成的路由。

相同目的有可能发现不同的路由，更具协议路由优先级来决定最优路由。

#### 最长匹配原则

路由设备收到 IP 数据包，根据数据包目的 IP 地址跟本地路由表所有表项逐位匹配找到前缀匹配度最长的条目，然后判断是否为同一网段。

#### 缺省路由

报文目的地址无法匹配路由表的地址，选择缺省路由进行转发。没有缺省路由且报文目的地址不在路由表，报文会被丢弃并返回一个 [ICMP](./icmp.md) 报文报告目的地址或网络不可达。

缺省路由可以手动配置，也可使动态路由协议生成。

#### 自治系统

自治系统 AS（Autonomous System）是在一个（多个）实体管辖（企业、运营商或机构）下的所有 IP 网络和路由器的网络，在互联网执行共同的路由策略。

每个 AS 可以支持多个内部网关路由 IGP 协议，每个 AS 都有唯一 AS 号标识。

#### 转发流程

当 IP 数据包到达路由器时，路由器按照 “接收校验→路由查找→转发处理→发送” 四个阶段进行处理并转发。

路由器只考虑将 IP 数据包转发到哪个下一跳，不会关心或修改数据包的源 IP 地址和目的 IP 地址。

**1. 接收数据报进行合法性校验**

- 版本校验：IPv4 或 IPv6 版本号。
- 头部校验和：IPv6 取消头部校验和，由二层或上层下一负责校验。
- TTL 检查：将 IP 数据报的 TTL 减 1，为 0 后丢弃数据包。
- 分片检查：IPv4 分片等待后续分片，组装完整后再处理。

**2. 基于目的 IP 地址查找路由表**

路由器提取 IP 数据包的目的 IP 地址，在路由表中进行最长前缀匹配：

- 对比目的 IP 地址与路由表中所有 “Destination” 字段的前缀（子网掩码覆盖的位数），选择**前缀最长**的路由条目（前缀越长，网络范围越小，路由越精确）。
- 若存在多条前缀长度相同的路由（如多路径路由），则根据 “Metric 值” 选择优先级最高的路由；若 Metric 也相同，可能通过负载均衡策略转发。
- 若未找到任何匹配的路由（包括默认路由`0.0.0.0/0`）：丢弃数据包，并向源主机发送 **ICMP 目标不可达报文**（Type 3, Code 0/1）。

**3. 转发前的处理**

- 更新头部校验和：修改了 TTL 值需要重新计算头部校验和。
- 确定下一跳和出接口
  - 直连路由：出接口直连目标主机。
  - 非直连路由：发送给下一跳路由器。
- 封装二层帧头：不同接口二层网络类型可能不同，需要重新封装二层帧头。
  - 目的 MAC 地址：ARP 协议查询获取下一跳路由器出接口。
  - 源 MAC 地址：路由器自身出接口的 MAC 地址。
  - 帧类型：根据 IP 版本设置。

**4. 发送数据包**

路由器将封装好的二层帧的数据报通过出接口发送到下一跳设备。

## 分片重组

IP 报文的发送依赖链路层提供的服务，当数据报大小超过链路层最大传输单元 MTU 后，需要对报文分片传输，直到数据分片到达最终目的地才会被重组。

分片头部处理规则：

- 修改总长度为当前分片实际长度。
- 修改标志最低位，1 表示还有分组，0 表示最后一个分组。
- 计算片偏移，第一个分片片偏移 = 0，第二个分片片偏移 = 第一个分片数据长度 / 8。

⚠️注意，分片可能发生在链路中的任何一个路由器，由于同一数据报的不同分片可能经由不同路径到达目的地，所以路由器没有能力重组原始的数据报，必须到目的主机才能重组。

IP 分片存在的问题：

- IP 重组可能失败：只要有一个分片丢失，目标主机就无法重组原始 IP 数据报。
- 性能问题：路由器分片、目标主机重组分片消耗 CPU 资源，分片越多丢包概率越高。

解决方法：

- **Path MTU 发现**：路径 MTU 发现机制，源主机发送 DF 位 = 1 的探测分组，自动探测路径中的最小 MTU，按照该 MTU 生成分组。
- 限制分组大小：应用层或传输层主动控制数据大小。
- IPv6：强制要求源主机进行 PMTUD，路由器不对 IPv6 进行分片。

