# Internet 协议

IP（Internet Protocol，网际协议）是 TCP/IP 协议族的核心协议之一，位于网络层，负责在不同网络之间传递数据报。

[TOC]

## 地址结构

IP 地址用来在互联网中唯一标识一台设备的网卡，用于在 TCP/IP 网络中定位设备并实现数据包路由。

核心作用：

- **网络定位**：通过 IP 地址确定数据包的 “源设备” 和 “目标设备” 所在的网络位置；
- **路由转发**：路由器通过 IP 地址判断数据包的转发路径，确保数据从源到目标的传递。

### IPv4 地址结构

IPv4 地址长度 32 位（4 字节），采用点分十进制表示。32 位二进制数被平均分为 4 段（每段 8 位，即 1 字节），每段将二进制转换为十进制（取值范围 0-255），段之间用 “.” 分隔，例如：

- 二进制原始形式：`11000000.10101000.00000001.00000001`
- 点分十进制形式：`192.168.1.1`（常见的家庭路由器网关地址）

#### 子网掩码

子网掩码用于划分“网络范围”和“主机标识”，解决 IP 地址资源分配效率低、网络广播风暴等问题，通过 “二进制与运算” 实现对 IP 地址的 “语义解读”。

子网掩码格式与 IP 地址完全一致，二进制 1 对应网络部分，二进制 0 对应主机部分。

核心作用包括：

- **拆分 IP 地址**：区分网络位和主机位，网络位代表主机所属的网络范围，主机位代表网络中的具体设备。
- **规划子网**：解决 IP 地址浪费问题，通过延长网络位、缩短主机位，将大网络拆分位多个子网，每个子网仅分配满足需求的主机数量。
- **判断主机归属**：判断数据传输目标主机是否在同一子网，同一子网内数据直接通过交换机传输，跨子网需要转发到网关在路由到目标网络。

#### 地址分类

早期为了区分不同规模的网络，按照网络位+主机位划分为 A/B/C/D/E 五类。

特殊场景：

- 网络地址：主机位全为 0 的地址，用于标识整个网络，不可分配给设备，如 192.168.1.0。
- 广播地址：主机位全为 1 的地址，用来向子网所有设备发送数据。
- 私有地址：仅在局域网内使用，通过 NAT 转换为公网地址。
  - A 类：`10.0.0.0 ~ 10.255.255.255`（1 个大段）；
  - B 类：`172.16.0.0 ~ 172.31.255.255`（16 个小段）；
  - C 类：`192.168.0.0 ~ 192.168.255.255`（256 个小段）。

### IPv6 地址结构

IPv6 地址长度 128 位（16 字节），128 位二进制数被平均分为 8 段（每段 16 位，即 2 字节），每段将二进制转换为**4 位十六进制数**（取值 0000-FFFF），段之间用 “:” 分隔，例如：

- 冒分十六进制形式：`2001:0000:0000:0000:0000:0000:0000:0001`（这是 IETF 的测试地址，可简化为`2001::1`）。
- 简化表示：省略每组前导 0，用双冒号“::”代替全零组。双冒号不能重复表示，例如 `2001::1:0:0:0:1`。

IPv6 地址采用 **“网络前缀 + 子网 ID + 接口 ID”** 的三级结构：

- **网络前缀**：表示全球唯一的网络区块。
- **子网 ID**：标识不同的子网。
- **接口 ID**：表示子网内的具体设备接口。

## 报文结构

IP 提供一种尽力而为、无连接的数据报交付服务。

- 尽力而为：不能保证 IP 数据报能成功到达目的地。
- 无链接：不维护网络中数据报相关的链接状态信息。
- 面向数据报：数据以数据包为单位传输，每个数据包包含目的和源地址，可独立路由。

⚠️注意：每个数据报独立路由，就可能存在乱序到达的问题。

### IPv4 数据报结构

IPv4 头部固定长度为 20 字节，选项字段长度不固定。

```bash
   0                               15 16                            31
   +----------------+-----------+----+-------------------------------+
   |  Version | IHL |     DS    |ECN |         Total Length          |
   +----------+-----+-----------+----+-------------------------------+
   |         Identification          |Flags|    Fragment Offset      |
   +----------------+----------------+-------------------------------+
   |        TTL     |    Protocol    |       Header Checksum         |
   +----------------+----------------+-------------------------------+
   |                          Source IP Address                      |
   +-----------------------------------------------------------------+
   |                        Destination IP Address                   |
   +-----------------------------------------------------------------+
   |                               Options                           |
   +-----------------------------------------------------------------+
   |                                 Data                            |
   +-----------------------------------------------------------------+
```

- 版本号（4 位）：IPv4 为 4，IPv6 为 6。
- 头部长度（4 位）：最大 60 字节。
- 服务类型：前 6 位为服务字段提供不同类型服务，后 2 位是显式拥塞通知字段。
- 总长度：IPv4 数据报总长度，最大 65535 字节。
- 标识符：分片计数，没法送一个数据报计数加 1。
- 标志（3 位）：最高位保留，中间位表示对分组是否进行分片（0-分片，1-不能分片），最低位表示分组的数据报结束（0-结束，1-未结束）。
- 分片偏移：分片在原分组的相对位置。
- TTL：数据报经过路由器数量的上限。
- 协议：数据报携带数据类型，UDP=17，TCP=6。
- 头部校验和：仅计算 IPv4 头部，每经过的设备都要计算校验。
- 选项：用来支持排错、测量以及安全等措施。在必要的时候插入值为0的填充字节。

### IPv6 数据报结构

IPv6 报文结构在设计上相比 IPv4 更加简洁高效，头部固定大小 40 字节，有效载荷包括**扩展首部（可选）**和**上层协议数据**。

```bash
    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |Version| Traffic Class |              Flow Label               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |         Payload Length        |  Next Header  |   Hop Limit   |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                                                               |
   +                                                               +
   |                                                               |
   +                         Source Address                        +
   |                                                               |
   +                                                               +
   |                                                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                                                               |
   +                                                               +
   |                                                               |
   +                      Destination Address                      +
   |                                                               |
   +                                                               +
   |                                                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                      Extension Headers                        |
   +                         ... ...                               +
```

- 版本号（4 位）：IPv4 为 4，IPv6 为 6。
- 流量类别（8 位）：区分报文优先级和 QoS，支持流量调度。
- 流标签（20 位）：标识 IP 数据包的一个流，路由器基于同一流的数据报进行相同处理。
- 有效载荷长度（16 位）：固定头部之后的数据长度，包含扩展报头。
- 下一报头（8 位）：扩展首部的类型，没有则标识上层协议（TCP=6，UDP=17，ICMPv6=58）。
- 跳数限制（8 位）：类似 TTL，没经过一个路由器减 1。
- 扩展首部：IPv6 取消了 IPv4 首部中的可选字段，仅在需要特定功能时添加扩展首部，由接收方处理，路由器不处理扩展首部。

## IP 转发

IP 转发是网络设备接收一个 IP 数据包后，根据数据包的**目的 IP 地址**和设备自身的**路由表**，将数据包从一个网络接口转发到另一个网络接口，最终实现数据包从源主机到目标主机的跨网络传输过程。

> PC 与路由器处理 IP 数据报的区别在于，PC 不转发不是自己生成的数据报。

### 路由表

路由表存储 “目的网络地址→下一跳地址→出接口” 映射关系，IP 转发的决策完全一体累设备中的路由表，每次转发一个数据报都需要从中查找信息。

#### 路由表字段

Linux 使用 `route -n` 查看路由表：

```bash
root@iZf8z4o3lbylu7kddpzwa1Z:~# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         172.31.159.253  0.0.0.0         UG    100    0        0 eth0
```

- **Destination**：目的网络地址，`0.0.0.0/0`表示默认路由。
- **Gateway**：下一跳IP地址，数据报需要转发到的下一个网络设备接口 IP，`0.0.0.0`表示直连网络。
- **Genmask**：目的网络的子网掩码。
- **Iface**：出接口，数据报从设备的哪个物理接口或逻辑接口发送出去。
- **Metric**：路由度量值，存在多条到达同一目的网络路由时，选择 Metric 最小的路由，有路由协议计算。
- **Flags**：路由标记，U 表示路由可用，G 表示需要经过网关，H 表示目的是单台主机。

> 默认路由：路由表中无法找到目标 IP 地址对应的精确匹配路由时，将数据报转发给默认路由指定的下一跳设备。

#### 转发流程

当 IP 数据包到达路由器时，路由器按照 “接收校验→路由查找→转发处理→发送” 四个阶段进行处理并转发。

**1. 接收数据报进行合法性校验**

- 版本校验：IPv4 或 IPv6 版本号。
- 头部校验和：IPv6 取消头部校验和，由二层或上层下一负责校验。
- TTL 检查：将 IP 数据报的 TTL 减 1，为 0 后丢弃数据包。
- 分片检查：IPv4 分片等待后续分片，组装完整后再处理。

**2. 基于目的 IP 地址查找路由表**

路由器提取 IP 数据包的目的 IP 地址，在路由表中进行最长前缀匹配：

- 对比目的 IP 地址与路由表中所有 “Destination” 字段的前缀（子网掩码覆盖的位数），选择**前缀最长**的路由条目（前缀越长，网络范围越小，路由越精确）。
- 若存在多条前缀长度相同的路由（如多路径路由），则根据 “Metric 值” 选择优先级最高的路由；若 Metric 也相同，可能通过负载均衡策略转发。
- 若未找到任何匹配的路由（包括默认路由`0.0.0.0/0`）：丢弃数据包，并向源主机发送 **ICMP 目标不可达报文**（Type 3, Code 0/1）。

**3. 转发前的处理**

- 更新头部校验和：修改了 TTL 值需要重新计算头部校验和。
- 确定下一跳和出接口
  - 直连路由：出接口直连目标主机。
  - 非直连路由：发送给下一跳路由器。
- 封装二层帧头：不同接口二层网络类型可能不同，需要重新封装二层帧头。
  - 目的 MAC 地址：ARP 协议查询获取下一跳路由器出接口。
  - 源 MAC 地址：路由器自身出接口的 MAC 地址。
  - 帧类型：根据 IP 版本设置。

**4. 发送数据包**

路由器将封装好的二层帧的数据报通过出接口发送到下一跳设备。

