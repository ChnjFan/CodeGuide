# Internet 协议

IP（Internet Protocol，网际协议）是 TCP/IP 协议族的核心协议之一，位于网络层，负责在不同网络之间传递数据报。

[TOC]

## 报文结构

IP 提供一种尽力而为、无连接的数据报交付服务。

- 尽力而为：不能保证 IP 数据报能成功到达目的地。
- 无链接：不维护网络中数据报相关的链接状态信息。
- 面向数据报：数据以数据包为单位传输，每个数据包包含目的和源地址，可独立路由。

⚠️注意：每个数据报独立路由，就可能存在乱序到达的问题。

### IPv4 数据报结构

IPv4 头部固定长度为 20 字节，选项字段长度不固定。

```bash
   0                               15 16                            31
   +----------------+-----------+----+-------------------------------+
   |  Version | IHL |     DS    |ECN |         Total Length          |
   +----------+-----+-----------+----+-------------------------------+
   |         Identification          |Flags|    Fragment Offset      |
   +----------------+----------------+-------------------------------+
   |        TTL     |    Protocol    |       Header Checksum         |
   +----------------+----------------+-------------------------------+
   |                          Source IP Address                      |
   +-----------------------------------------------------------------+
   |                        Destination IP Address                   |
   +-----------------------------------------------------------------+
   |                               Options                           |
   +-----------------------------------------------------------------+
   |                                 Data                            |
   +-----------------------------------------------------------------+
```

- 版本号（4 位）：IPv4 为 4，IPv6 为 6。
- 头部长度（4 位）：最大 60 字节。
- 服务类型：前 6 位为服务字段未使用，后 2 位是显式拥塞通知字段。
- 总长度：IPv4 数据报总长度，最大 65535 字节。
- 标识符：分片计数，没法送一个数据报计数加 1。
- 标志（3 位）：最高位保留，中间位表示对分组是否进行分片（0-分片，1-不能分片），最低位表示分组的数据报结束（0-结束，1-未结束）。
- 分片偏移：分片在原分组的相对位置。
- TTL：是个孩子数据报经过路由器数量的上限。
- 协议：数据报携带数据类型，UDP=17，TCP=6。
- 头部校验和：仅计算 IPv4 头部，每经过的设备都要计算校验。
- 选项：用来支持排错、测量以及安全等措施。在必要的时候插入值为0的填充字节。

