# Internet 协议

IP（Internet Protocol，网际协议）是 TCP/IP 协议族的核心协议之一，位于网络层，负责在不同网络之间传递数据报。

[TOC]

## 地址结构

IP 地址用来在互联网中唯一标识一台设备的网卡，用于在 TCP/IP 网络中定位设备并实现数据包路由。

核心作用：

- **网络定位**：通过 IP 地址确定数据包的 “源设备” 和 “目标设备” 所在的网络位置；
- **路由转发**：路由器通过 IP 地址判断数据包的转发路径，确保数据从源到目标的传递。

### IPv4 地址结构

IPv4 地址长度 32 位（4 字节），采用点分十进制表示。32 位二进制数被平均分为 4 段（每段 8 位，即 1 字节），每段将二进制转换为十进制（取值范围 0-255），段之间用 “.” 分隔，例如：

- 二进制原始形式：`11000000.10101000.00000001.00000001`
- 点分十进制形式：`192.168.1.1`（常见的家庭路由器网关地址）

#### 子网掩码

子网掩码用于划分“网络范围”和“主机标识”，解决 IP 地址资源分配效率低、网络广播风暴等问题，通过 “二进制与运算” 实现对 IP 地址的 “语义解读”。

子网掩码格式与 IP 地址完全一致，二进制 1 对应网络部分，二进制 0 对应主机部分。

核心作用包括：

- **拆分 IP 地址**：区分网络位和主机位，网络位代表主机所属的网络范围，主机位代表网络中的具体设备。
- **规划子网**：解决 IP 地址浪费问题，通过延长网络位、缩短主机位，将大网络拆分位多个子网，每个子网仅分配满足需求的主机数量。
- **判断主机归属**：判断数据传输目标主机是否在同一子网，同一子网内数据直接通过交换机传输，跨子网需要转发到网关在路由到目标网络。

#### 地址分类

早期为了区分不同规模的网络，按照网络位+主机位划分为 A/B/C/D/E 五类。

特殊场景：

- 网络地址：主机位全为 0 的地址，用于标识整个网络，不可分配给设备，如 192.168.1.0。
- 广播地址：主机位全为 1 的地址，用来向子网所有设备发送数据。
- 私有地址：仅在局域网内使用，通过 NAT 转换为公网地址。
  - A 类：`10.0.0.0 ~ 10.255.255.255`（1 个大段）；
  - B 类：`172.16.0.0 ~ 172.31.255.255`（16 个小段）；
  - C 类：`192.168.0.0 ~ 192.168.255.255`（256 个小段）。

### IPv6 地址结构

IPv6 地址长度 128 位（16 字节），128 位二进制数被平均分为 8 段（每段 16 位，即 2 字节），每段将二进制转换为**4 位十六进制数**（取值 0000-FFFF），段之间用 “:” 分隔，例如：

- 冒分十六进制形式：`2001:0000:0000:0000:0000:0000:0000:0001`（这是 IETF 的测试地址，可简化为`2001::1`）。
- 简化表示：省略每组前导 0，用双冒号“::”代替全零组。双冒号不能重复表示，例如 `2001::1:0:0:0:1`。

IPv6 地址采用 **“网络前缀 + 子网 ID + 接口 ID”** 的三级结构：

- **网络前缀**：表示全球唯一的网络区块。
- **子网 ID**：标识不同的子网。
- **接口 ID**：表示子网内的具体设备接口。

## 报文结构

IP 提供一种尽力而为、无连接的数据报交付服务。

- 尽力而为：不能保证 IP 数据报能成功到达目的地。
- 无链接：不维护网络中数据报相关的链接状态信息。
- 面向数据报：数据以数据包为单位传输，每个数据包包含目的和源地址，可独立路由。

⚠️注意：每个数据报独立路由，就可能存在乱序到达的问题。

### IPv4 数据报结构

IPv4 头部固定长度为 20 字节，选项字段长度不固定。

```bash
   0                               15 16                            31
   +----------------+-----------+----+-------------------------------+
   |  Version | IHL |     DS    |ECN |         Total Length          |
   +----------+-----+-----------+----+-------------------------------+
   |         Identification          |Flags|    Fragment Offset      |
   +----------------+----------------+-------------------------------+
   |        TTL     |    Protocol    |       Header Checksum         |
   +----------------+----------------+-------------------------------+
   |                          Source IP Address                      |
   +-----------------------------------------------------------------+
   |                        Destination IP Address                   |
   +-----------------------------------------------------------------+
   |                               Options                           |
   +-----------------------------------------------------------------+
   |                                 Data                            |
   +-----------------------------------------------------------------+
```

- 版本号（4 位）：IPv4 为 4，IPv6 为 6。
- 头部长度（4 位）：最大 60 字节。
- 服务类型：前 6 位为服务字段提供不同类型服务，后 2 位是显式拥塞通知字段。
- 总长度：IPv4 数据报总长度，最大 65535 字节。
- 标识符：分片计数，没法送一个数据报计数加 1。
- 标志（3 位）：最高位保留，中间位表示对分组是否进行分片（0-分片，1-不能分片），最低位表示分组的数据报结束（0-结束，1-未结束）。
- 分片偏移：分片在原分组的相对位置。
- TTL：数据报经过路由器数量的上限。
- 协议：数据报携带数据类型，UDP=17，TCP=6。
- 头部校验和：仅计算 IPv4 头部，每经过的设备都要计算校验。
- 选项：用来支持排错、测量以及安全等措施。在必要的时候插入值为0的填充字节。

### IPv6 数据报结构

IPv6 报文结构在设计上相比 IPv4 更加简洁高效，头部固定大小 40 字节，有效载荷包括**扩展首部（可选）**和**上层协议数据**。

```bash
    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |Version| Traffic Class |              Flow Label               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |         Payload Length        |  Next Header  |   Hop Limit   |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                                                               |
   +                                                               +
   |                                                               |
   +                         Source Address                        +
   |                                                               |
   +                                                               +
   |                                                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                                                               |
   +                                                               +
   |                                                               |
   +                      Destination Address                      +
   |                                                               |
   +                                                               +
   |                                                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                      Extension Headers                        |
   +                         ... ...                               +
```

- 版本号（4 位）：IPv4 为 4，IPv6 为 6。
- 流量类别（8 位）：区分报文优先级和 QoS，支持流量调度。
- 流标签（20 位）：标识 IP 数据包的一个流，路由器基于同一流的数据报进行相同处理。
- 有效载荷长度（16 位）：固定头部之后的数据长度，包含扩展报头。
- 下一报头（8 位）：扩展首部的类型，没有则标识上层协议（TCP=6，UDP=17，ICMPv6=58）。
- 跳数限制（8 位）：类似 TTL，没经过一个路由器减 1。

#### 扩展首部

IPv6 取消了 IPv4 首部中的可选字段，仅在需要特定功能时添加扩展首部，由接收方处理，路由器不处理扩展首部。

