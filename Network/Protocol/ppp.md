# PPP 协议

PPP（Point-to-Point Protocol）点到点协议是一种串行链路上传输 IP 数据报的方法，主要用于在两个直接连接的设备（如计算机与路由器、路由器与路由器）之间建立通信链路，实现数据的可靠传输。应用于拨号上网、专线连接、VPN（虚拟专用网）等场景。

[TOC]

PPP 协议是一个协议集合，由**三个功能独立的子协议**组成，三者协同完成链路建立、数据传输和链路释放流程。

- **LCP（ Link Control Protocol）链路控制协议**：建立和维护点到点链路的通信路径。
- **NCP（Network Control Protocol）网络控制协议**：协商网络层协议，确保数据包在链路上正常传输。
- 数据帧封装协议：定义 PPP 帧的格式，封装网络层数据包（如 IP 包），并提供差错检测。

## LCP 协议

LCP 协议负责链路的整个生命周期管理，主要功能包括：

- 链路建立和协商：双方设备交换 LCP 报文，协商链路关键参数。
  - 最大接收单元 MRU：链路传输最大帧长度，默认 1500 字节。
  - 认证协议：PAP、CHAP
  - 压缩算法：BSD Compress
- 链路测试：发送 Echo-Request/Echo-Reply 报文检测链路连通性。
- 链路释放：发送 Terminate-Request/Terminate-Ack 报文主动关闭链路。
- 差错检测：监控链路状态，连续超时无响应判断链路故障并尝试重连。

### LCP 帧格式

LCP 使用的帧格式基于高级数据链路控制 HDLC 协议的格式建立链路协议。

```bash
           |<--------------------------      7 - 1508 bytes      --------------------------->|
           +---0x7E---+---0xFF---+---0x03---+----------+---------------+----------+---0x7E----
           |   Flag   | Address  | Control  | Protocol | Information   |   FCS    |   Flag   |
           | 01111110 | 11111111 | 00000011 | 8/16bits |      *        | 16 bits  | 01111110 |
           +----------+----------+----------+----------+---------------+----------+-----------
                                                       | 0-1500 bytes  |     
                                              |                                              |
                                              +----------+----------+-----------------+-------
     Format of an LCP packet:                 |   Code   |Identifier|      Length     | Data |
                                              |  8 bits  |  8 bits  |     16 bits     | ...  |
                                              +----------+----------+-----------------+-------
                                                                                      |      |
                           |                                                                 |
                           +----------+----------+--------+----------+----------+------+------
     Format of LCP         |   Type   |  Length1 |  Data1 |   Type   |  Length1 | Data2| ... |
 configuration parameters: |  8 bits  |  8 bits  |  ...   |  8 bits  |  8 bits  | ...  |     |
                           +----------+----------+--------+----------+----------+------+------
```

帧前后边界的标志位固定为 0x7E 标识出一个 LCP 帧的范围。

⚠️**如何保证数据中出现 0x7E 时能避免接收方误判帧边界？**

答：需要区分 PPP 工作在异步链路还是同步链路：

1. 异步链路：使用**字节填充**，通过转移字符对冲突数据和转移字符本身做替换。
   - 数据中出现标志位相同的`0x7E`，会将其替换为两字节序列`0x7D 0x5E`。其中`0x7D`是 PPP 的转义字符，`0x5E`是`0x7E`与`0x20`异或后的结果，以此区分数据中的`0x7E`和帧边界标志。
   - 若数据中本身存在转义字符`0x7D`，则会将其替换为`0x7D 0x5D`，防止转义字符被误解析。
