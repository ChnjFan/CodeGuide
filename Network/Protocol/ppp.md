# PPP 协议

PPP（Point-to-Point Protocol）点到点协议是一种串行链路上传输 IP 数据报的方法，主要用于在两个直接连接的设备（如计算机与路由器、路由器与路由器）之间建立通信链路，实现数据的可靠传输。应用于拨号上网、专线连接、VPN（虚拟专用网）等场景。

[TOC]

PPP 协议是一个协议集合，由**三个功能独立的子协议**组成，三者协同完成链路建立、数据传输和链路释放流程。

- **LCP（ Link Control Protocol）链路控制协议**：建立和维护点到点链路的通信路径。

- **NCP（Network Control Protocol）网络控制协议**：协商网络层协议，确保数据包在链路上正常传输。

- 数据帧封装协议：定义 PPP 帧的格式，封装网络层数据包（如 IP 包），并提供差错检测。

## 帧格式

  PPP 协议使用的帧格式基于高级数据链路控制 HDLC 协议的格式建立链路协议。

  ```bash
             |<--------------------------      7 - 1508 bytes      --------------------------->|
             +---0x7E---+---0xFF---+---0x03---+----------+---------------+----------+---0x7E----
             |   Flag   | Address  | Control  | Protocol | Information   |   FCS    |   Flag   |
             | 01111110 | 11111111 | 00000011 | 8/16bits |      *        | 16 bits  | 01111110 |
             +----------+----------+----------+----------+---------------+----------+-----------
                                                         | 0-1500 bytes  |     
                                                |                                              |
                                                +----------+----------+-----------------+-------
       Format of an LCP packet:                 |   Code   |Identifier|      Length     | Data |
                                                |  8 bits  |  8 bits  |     16 bits     | ...  |
                                                +----------+----------+-----------------+-------
                                                                                        |      |
                             |                                                                 |
                             +----------+----------+--------+----------+----------+------+------
       Format of LCP         |   Type   |  Length1 |  Data1 |   Type   |  Length1 | Data2| ... |
   configuration parameters: |  8 bits  |  8 bits  |  ...   |  8 bits  |  8 bits  | ...  |     |
                             +----------+----------+--------+----------+----------+------+------
  ```

  - 帧前后边界的标志位固定为 0x7E 标识出一个 LCP 帧的范围。

  ⚠️**如何保证数据中出现 0x7E 时能避免接收方误判帧边界？**

  答：需要区分 PPP 工作在异步链路还是同步链路：

  1. 异步链路：使用**字节填充**，通过转移字符对冲突数据和转移字符本身做替换。
     - 数据中出现标志位相同的`0x7E`，会将其替换为两字节序列`0x7D 0x5E`。其中`0x7D`是 PPP 的转义字符，`0x5E`是`0x7E`与`0x20`异或后的结果，以此区分数据中的`0x7E`和帧边界标志。
     - 若数据中本身存在转义字符`0x7D`，则会将其替换为`0x7D 0x5D`，防止转义字符被误解析。
  2. 同步链路：使用**零比特填充**，破坏特定比特序列 `01111110` 的形成。
     - 发送端处理数据比特流，扫描标志位之外的区域，如果检测到连续的 5 个 `1`，就立即插入一个 `0`，防止出现 `0x7E`。
     - 接收端接收数据扫描比特流，如果扫描连续的 5 个 `1`，就删除后面的一个 `0`。

  > 异步链路：以 “字符” 为基本传输单位，每个字符前后添加额外同步位实现时钟同步和数据边界标识。用于早期拨号上网传输 PPP 帧，串口设备通信和低速外设。
  >
  > 同步链路：以 “帧” 为单位传输连续比特流，通过全局统一的时钟信号协调收发节奏，无需为每个字符添加同步位。

  - PPP 协议运用在点对点链路上，可以唯一标识对方，不需要知道对方数据链路层的地址，地址字段固定 `0xFF`。

  - 控制字段固定 `0x03` 表明为无序号帧，PPP 协议默认没有采用序列号和重传机制实现可靠传输。

  - 协议字段表明携带的数据类型，LCP 为 `0xC021`，PAP 为 `0xC023`，CHAP 为 `0xC223`，IPCP 为 `0x8021`。
  - 代码字段标识 LCP 请求或响应的操作类型。
  - 标识字段请求方提供序列号，后续消息递增。
  - 长度字段最大不超过 MRU（链路最大接收单元）。

## 工作机制

PPP 协议包含 Dead、Establish、Authenticate、Network、Terminate 五个阶段：

- Dead 阶段：链路不可用，通信双方的两端检测到物理链路上有载波信号，从 Dead 阶段跃迁至 Establish 阶段。
- Establish 阶段：PPP 协议开始进行 LCP 协商，接口 UP 后 LCP 状态机从 Initial / Starting 状态转变到 Open 状态后完成 LCP 协商。
- Authenticate 阶段：完成 LCP 协商后根据协商的认证协议进行链路身份认证，默认不进行认证。
- Network 阶段：通过 NCP 协议选择和配置网络层协议，并进行网络层参数协商。
- Terminate 阶段：任何时候都可中断链路，如载波丢失、认证失败或主动关闭链路等。

## LCP 协议

LCP 协议负责链路的整个生命周期管理，主要功能包括：

- 链路建立和协商：双方设备交换 LCP 报文，协商链路关键参数。
  - 最大接收单元 MRU：链路传输最大帧长度，默认 1500 字节。
  - 认证协议：PAP、CHAP
  - 压缩算法：BSD Compress
- 链路测试：发送 Echo-Request/Echo-Reply 报文检测链路连通性。
- 链路释放：发送 Terminate-Request/Terminate-Ack 报文主动关闭链路。
- 差错检测：监控链路状态，连续超时无响应判断链路故障并尝试重连。

### 链路协商

链路建立的本质是双方协商一致的链路规则，LCP 通过交换配置报文完成对 MRU、认证协议、压缩协议和链路质量监控等核心参数的协商。

协商流程：

1. 发送方发送 Configure-Request 的配置请求报文，携带自身支持的参数，如 MRU = 1492，认证协议 = CHAP。
2. 接收方回复响应报文：
   - 认可所有参数，回复 Configure-Ack 报文标识协商一致。
   - 若不认可部分参数，回复 Configure-Nak 并携带可接受的参数（如 MRU = 1500），发送方需要重新发送请求报文。
   - 若拒绝不支持的参数，回复 Configure-Reject，发送方需要删除对应参数重新发送请求报文。
3. 反复协商直到所有参数被 Configure-Ack 确认，参数协商成功。

### 链路身份认证

参数协商阶段约定认证协议后，LCP 触发认证流程，通过交换认证报文验证链路对方身份。

- PAP 密码认证协议：被认证方（用户）发送明文账号密码，认证方（ISP）验证后回复`Authenticate-Ack`（通过）或`Authenticate-Nak`（失败）；
- CHAP 查询握手认证协议：认证方发送随机 “挑战码”，被认证方用密码哈希计算后返回 “响应码”，认证方对比后回复`Success`（通过）或`Failure`（失败）。

### 链路维护和故障检测

链路建立之后，LCP 需要持续监控链路状态。

- 回声检测：定期发送`Echo-Request`报文，对方响应 `Echo-Reply`报文，表示链路正常。多次未回复判定链路异常，触发重连流程。
- 链路质量监控：双方统计链路的丢包率、误码率等指标，超过阈值后发送 `Quality-Request`报文请求重新评估链路。若质量无法恢复，LCP 发送`Terminate-Request`报文释放链路。

### 链路释放

当通信结束（如用户主动断开拨号）或链路故障无法恢复时，LCP 通过交换**终止报文（Terminate Packet）** 优雅释放链路，避免资源泄漏。

1. **发起方发送`Terminate-Request`**：发起方（如用户电脑）向接收方发送链路终止请求，说明释放原因（如 “用户主动断开”“链路故障”）；
2. **接收方回复`Terminate-Ack`**：接收方确认终止请求，清空链路参数（如 MRU、认证状态），停止数据传输；
3. **链路关闭**：双方停止发送 LCP 报文，物理链路（如拨号连接）断开，回到 “链路不可用” 状态。

## NCP 协议

NCP 网络控制协议在 LCP 完成链路建立和认证后，链路双端进入网络状态后开始网络层的协商，实现让链路传输特定网络层的数据。

- IPv4 对应 IPCP 协议（IP 控制协议）。
- IPv6 对应 IPV6CP 协议。

### IPCP 协商流程

IPCP 分组使用与 LCP 分组相同的交换机制和格式，将协议字段设置为 `0x8021`。

1. 客户端构造 `Configure-Request`报文，携带**IPCP 参数选项**：
   - IP 地址选项（Option 3）：填写 `0.0.0.0` 请求服务器分配地址。
   - DNS 服务器地址选项（Option 129/131）：请求服务器下发主备 DNS 地址。
   - Van Jacobson 头部压缩选项（Option 2）：请求启用 IP/TCP 头部压缩。
2. 服务器处理请求并回应。
   - 根据自身策略返回应答报文，报文类型与 LCP 协商相同：`Configure-Ack`、`Configure-Nak`、`Configure-Reject`。
3. 两端均接收到 `Configure-Ack` 后协商成功后进入数据传输。

