# RIP 协议

RIP（Routing Information Protocol）路由信息协议是一种较为简单的内部网关协议IGP，基于距离矢量（Distance-Vector）算法的经典内部网关协议，主要用于规模较小的网络中，比如校园网以及结构较简单的地区性网络。

[TOC]

## 协议规范

RIP 协议传输层基于 UDP 协议，主动发送更新的源/目的端口为 520。

支持静默模式：仅接受路由信息，不主动发送更新。

RIP有两个版本：

- **RIP-1**：有类别路由协议（Classful Routing Protocol），它只支持以广播方式发布协议报文。协议报文中没有携带掩码信息，它只能识别 A、B、C 主类网的路由，因此 RIP-1 无法支持路由聚合，也不支持不连续子网（Discontiguous Subnet）。
- **RIP-2**：无分类路由协议（Classless Routing Protocol），有两种报文传送方式：广播方式和组播方式，缺省将采用组播方式发送报文，使用的组播地址为224.0.0.9。当接口运行RIP-2广播方式时，也可接收RIP-1的报文。

RIP-2 报文携带掩码位，支持子网划分和路由聚合。

### RIP-1的报文格式

RIP-1报文由头部（Header）和多个路由表项（Route Entries）部分组成。在一个RIP报文中，最多可以有25个路由表项（受 512 字节限制）。

```bash
0               7              15              23              31
+---------------------------------------------------------------+
|      Command  |  Version     |            Must be zero        |
+---------------------------------------------------------------+
| Address family identifier    |            Must be zero        |
+---------------------------------------------------------------+
|                            IP address                         |
+---------------------------------------------------------------+
|                           Must be zero                        |
+---------------------------------------------------------------+
|                           Must be zero                        |
+---------------------------------------------------------------+
|                             Metric                            |
+---------------------------------------------------------------+
```

- 命令：区分报文类型。
  - Request报文，向邻居请求全部或部分路由信息；
  - Reponse报文，发送自己全部或部分路由信息，一个Response报文中最多包含25个路由表项。
- 版本号：目前版本为 RIP-1 和 RIP-2。
- 地址族标识：2 表示 IP 协议，Request 报文该字段为 0。
- 路由的目的IP地址：自然网段的地址，也可以是子网地址或主机地址。
- 路由的开销值。对于Request报文，此字段值为16（不可达），1-15（有效值）。

### RIP-2的报文格式

```bash
0               7              15              23              31
+---------------------------------------------------------------+
|      Command  |  Version     |            Must be zero        |
+---------------------------------------------------------------+
| Address family identifier    |            Route Tag           |
+---------------------------------------------------------------+
|                           IP Address                          |
+---------------------------------------------------------------+
|                           Subnet Mask                         |
+---------------------------------------------------------------+
|                           Next Hop                            |
+---------------------------------------------------------------+
|                           Metric                              |
+---------------------------------------------------------------+
```

- 外部路由标记
- 目的地址的掩码
- 下一跳地址：提供更好的下一跳地址，如果是 0.0.0.0，则表示发布此路由的路由器地址就是最优下一跳地址。

## 核心算法

RIP 协议的核心是**距离向量算法**（基于 Bellman-Ford 方程），核心逻辑是节点通过邻居的距离信息，动态计算到所有目标的最优路由。

### 算法原理

每个参与 RIP 的节点，仅需与直接相邻的节点交换路由信息，就能推算出全网的最优路由。

- **距离**：默认以跳数为单位，每经过一个网络 / 网关计 1 跳，范围 1-15（16 表示 “不可达”，视为无穷大）。默认设备与直连网络的跳数为 0。
- **向量**：每个路由条目包含 “目标地址 + 到目标的距离”，节点通过交换这些 “距离向量” 更新自身路由表。

距离向量算法基于 Bellman-Ford 方程，节点 i 到目标 j 的最优距离 D(i, j) 满足：

- D(i, i) = 0（自身到自身距离为 0）
- D (i,j) = min [ d (i,k) + D (k,j) ]（k 为 i 的直接邻居，d (i,k) 是 i 到 k 的直接距离，取所有邻居路径的最小值）。

### 算法流程

1. **初始化：路由表初始状态**

节点启动时，仅配置**直接连接的网络**到路由表中，需要相邻设备互相学习路由表项才能实现各网段路由互通。

直连路由条目：目的地址为该网络地址，距离为该网络的配置代价（默认为 1），下一跳为空，初始化超时定时器。

2. **路由信息交换：定期更新 + 触发更新**

RIP 协议启动后向相邻的路由器广播 Request 报文，相邻路由器将 RIP 路由表封装在 Response 报文后向接收接口对应网络广播，启动协议的路由器收到后形成自己的路由表。

- 定期更新：每 30 秒节点向直接邻居广播自身完整路由表，确保邻居同步更新路由。
- 触发更新：路由度量发生变化（链路失效、新路由出现等），节点立即发送更新（随机延迟防止拥塞）。

3. **路由表更新：最优路由选择逻辑**

节点收到邻居的路由更新后，按以下规则更新自身路由表：

- 对每个目标路由，计算 “邻居的度量 + 本地到该邻居的网络代价”（记为新度量）；

- 若本地无该目标的路由，且新度量≤15（有效），则添加该路由（目标地址、下一跳为发送邻居、度量为新度量），初始化超时定时器；

- 若本地已有该目标的路由：

  - 若下一跳就是发送邻居：无论新度量变大或变小，都更新为新度量（强制同步邻居的路由状态）；

  - 若下一跳是其他邻居：仅当新度量小于当前度量时，才替换路由（选择更优路径）；

- 若新度量 = 16（不可达）：标记该路由无效，启动垃圾回收定时器（120 秒后删除）。

4. **路由失效处理：定时器机制**

- 老化定时器：RIP 路由器连续 180 秒未收到邻居的路由更新报文，标记为无效（度量为 16）。

- 垃圾回收定时器：无效路由保留 120 秒，该路由仍向邻居广播不可达，避免邻居仍使用旧路由，超时后该路由被删除。
- 抑制定时器：RIP 设备收到对端的路由更新 cost 为16后，将对应路由进入抑制状态。为了防止路由震荡，抑制定时器超时前不接受路由更新报文。

## 核心机制

距离向量算法存在路由循环和收敛效率低的问题：

- **收敛效率低**：网络拓扑变化后，路由信息需要逐跳广播，每跳都要等待 30 秒定期更新周期，全网所有节点更新到最优路由的时间过长。
- **路由循环**：节点依赖邻居路由信息，无法感知到全网拓扑，拓扑变化后就路由信息未及时淘汰，引发互相误导，同时路由度量不断增大。
  - 例如，A→B→D 的链路失效后，B 未及时告知 A，A 仍向 B 发送 “可达 D” 的路由，B 则向 A 学习 “可达 D” 的路由，形成 A→B→A 的循环，度量从 3 逐步增至 16 才终止。
- 度量单一，无法适配复杂网络：仅使用跳数作为路由选择，无法结合当前网络实际状态（负载，延时、带宽等）。
- 最大跳数限制：为避免路由循环无限期持续，算法设定最大度量值为 16，仅适用中小型网络。

### 水平分割

水平分割是 RIP 协议优化路由循环问题的机制，核心思路是**避免节点向路由的学习来源反向传播该路由**，防止双路由环路。

#### 核心原理

节点向某邻居发送路由更新时，更新报文中过滤掉从该邻居学习到的路由，或标记为不可达，避免反向传播形成循环。

水平分割只能解决邻居之间的路由循环问题，对于多节点循环问题（如 A→B→C→A）仍需要计数到无穷大（度量增加到 16）来终止。

#### 实现方式

- 简单水平分割：向邻居发送更新时，直接省略从该邻居学习到的路由，减少更新报文大小，循环终止依赖 180 秒路由超时定时器，收敛速度慢。
- 水平分割+毒性逆转：向邻居发送更新时，将从该邻居学习到路由的度量值标记为 16（不可达），告知邻居改路由通过我不可达，快速终止循环。

假设网络拓扑：A←→B←→D（A 通过 B 学习到 D 的路由，度量为 3）

- 简单水平分割：A 向 B 发送路由更新时，不包含 “D 的路由”，B 不会从 A 处收到反向的 D 路由，避免 A→B→A 的循环。
- 毒性逆转：A 向 B 发送更新时，包含 “D 的路由” 但度量设为 16，B 收到后立即知道 “通过 A 无法到达 D”，不会误将 A 作为 D 的下一跳。

### 触发更新

触发更新是 RIP 协议解决收敛速度慢的机制，拓扑变化时立即发送更新，避免每次等待 30 秒定时周期，加速路由信息扩散。

#### 核心原理

当节点路由表发生变化后，立即向所有邻居发送更新报文，传递最新的路由状态。

- 为避免多个节点同时触发更新造成广播风暴，需要随机延迟 1-5 秒分散发送时间。

- 触发更新无需发送完整路由信息，仅发送状态变化的路由条目。

- 定期更新协同发送，如果触发更新 10 秒内就到定期更新，则触发更新不再发送更新。

如果网络拓扑频繁变化（链路抖动），可能导致大量触发更新包，随机延迟也可能导致部分节点先收到旧路由条目就，造成短时间内路由不一致。

#### 工作示例

网络拓扑：A←→B←→D（A 通过 B 学习到 D 的路由，B→D 的链路突然失效）

- 无触发更新：B 需等待 30 秒定期更新才会告知 A “D 不可达”，A 在 30 秒内仍会向 B 转发去往 D 的数据包，导致丢包。
- 有触发更新：B 检测到 B→D 链路失效后，立即（加 1-5 秒随机延迟）向 A 发送更新，告知 “D 的度量为 16（不可达）”，A 收到后立即更新路由表，停止向 B 转发 D 的数据包，收敛时间从 30 秒缩短至几秒。

## 关键问题

**问题 1**：RFC 1058 定义的 RIP 协议为何将 “不可达” 的度量值设为 16，而非更大的数字（如 100）？

**答案**：该设计是 “网络规模限制” 与 “收敛速度” 的权衡：

1. RIP 的核心限制是**最大有效跳数为 15**，16 作为 “无穷大” 需大于最大有效跳数，确保不会与有效路由混淆；
2. 若设为更大数字（如 100），当出现路由循环（如 A→B→C→A）时，“计数到无穷大” 的时间会显著延长（需 100 次更新），导致无效路由长期占用带宽、延迟收敛；
3. 16 的设计既满足中小型网络（直径≤15）的需求，又能快速终止 “计数到无穷大” 过程，减少路由不稳定的影响。

**问题 2**：RIP 协议的 “水平分割” 和 “触发更新” 机制分别解决了什么具体的路由问题？两者的协同作用是什么？

**答案**：

1. **水平分割**（含毒性逆转）：解决 “双向路由循环” 问题 —— 当两个网关（如 A 和 B）误学习到彼此的无效路由（A→B、B→A）时，水平分割会阻止 A 向 B 发送从 B 学习的路由（或标记为 16），直接切断循环，避免无效路由在两者间反复传播；
2. **触发更新**：解决 “拓扑变化后旧路由延迟淘汰” 问题 —— 当某路由失效（如 B→D 的链路中断）时，B 无需等待 30 秒定期更新，立即向邻居发送 “D 不可达” 的更新，加速失效信息传播；
3. **协同作用**：水平分割阻止小范围循环，触发更新加速失效信息扩散，两者结合大幅减少 “计数到无穷大” 的概率和时长，提升路由收敛速度，降低网络带宽消耗。

**问题 3**：RFC 1058 中规定 RIP 的路由表 “垃圾回收定时器” 为 120 秒，为何不直接在路由超时（180 秒）后立即删除路由，而要保留 120 秒？

**答案**：保留 120 秒的核心目的是**确保邻居节点能收到 “路由失效” 的通知**，避免 “路由黑洞”：

1. 路由超时（180 秒）后，节点仅标记该路由无效（度量设为 16），但不立即删除 —— 此时该节点仍会在更新中广播 “该路由不可达”（度量 16）；
2. 若立即删除，邻居节点可能仍保留该路由（基于之前的更新），并继续向该节点转发数据包，导致 “黑洞”（数据包丢失）；
3. 120 秒的保留期足以让所有邻居节点接收并处理 “路由失效” 的更新（即使存在网络延迟或数据包丢失，30 秒定期更新也能覆盖 2-3 次），待邻居更新后再删除路由，确保整个网络路由一致性。

**问题 4**：RIP-1 为什么无法处理主类网络划分为不同子网的情况？

**答案**：RIP-1 在路由更新报文中不传递子网掩码信息，仅能传递目标网络地址。

当主类网络划分为多个子网后，RIP-1 设备接收到更新报文后无法判断目标地址是子网还是主类网络。例如 B 类主类网络 `172.16.0.0/16` 被划分为子网 `172.16.0.0/22`（掩码 `255.255.252.0`）。RIP-1 路由器收到的只有目标网络 `172.16.0.0`，认为是整个 B 类网络 `172.16.0.0/16`，路由表中无法学习到多个子网的独立路由，导致数据无法完成子网的路由转发。

