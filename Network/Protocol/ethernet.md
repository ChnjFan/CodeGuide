# 以太网协议

以太网协议是局域网核心技术标准，规定了设备间如何在有线介质（双绞线、光纤等）上传输数据，包括数据帧格式、物理接口、传输速率等关键规范，是局域网 “互联互通” 的底层保障。

[TOC]

## 数据帧结构

以太网数据帧是数据传输的基本单位。

```bash
+-----------+-----------+-------------+--------------------+----------+
|   DMAC    |   SMAC    |     Type    |          Data      |   FCS    |
|  6 Bytes  |  6 Bytes  |   2 Bytes   |  Variable length   | 4 Bytes  |
+-----------+-----------+-------------+--------------------+----------+
|                                                                     |
                                           |                 |
+-------------+-----------+----------------+-----------------+
|   帧间隙     |  前同步码   |  帧开始定界符    |  Ethernet Frame |
|至少12Bytes   | 7 Bytes   |  1 Byte        | Variable length |
+-------------+-----------+----------------+-----------------+
```

- 帧间隙：每个以太帧之间都要有帧间隙（Inter Frame Gap），以便让帧接收者对接收的帧做必要的处理（如调整缓存的指针、更新计数、通知对报文进行处理等等）。
- 前同步码： IEEE 802.3 标准规定长度 7 个字节，每个字节值为 0xAA。
- 帧开始定界符：固定为 0xAB。、
- 目的地址和源地址：MAC 地址，6字节，标识帧的接收者和发送者。
- 协议类型：IPv4（0x0800）、ARP（0x0806）、IPv6（0x86DD）VLAN标签帧（0x8100）。
- 有效载荷：46~1500 字节，以太网最大传输单元 MTU = 1500。
- 帧校验序列：以太网通常使用循环冗余校验 CRC。

以太网帧最小长度为 64 字节，有效载荷的长度如果小于 46 字节，填充字节 0 到尾部。

以太网最大帧长度为1518字节（14 字节的头部和 4 字节 CRC 校验码）。

## MAC 地址

MAC（Media Access Control）地址用来定义网络设备的位置，由 **48 比特（6 字节）**长、12 位的 16 进制数字组成。

- 物理 MAC 地址：这种类型的 MAC 地址唯一的标识了以太网上的一个终端，该地址为全球唯一的硬件地址；
- 广播 MAC 地址：广播地址（FF-FF-FF-FF-FF-FF），用来表示LAN上的所有终端设备；
- 组播 MAC 地址：第 8bit 为 1 的MAC地址为组播MAC地址（例如01-00-00-00-00-00），用来代表LAN上的一组终端。

### MAC 地址表

MAC 地址表记录了交换机学习到的其他设备的 MAC 地址与接口的对应关系，以及接口所属 VLAN 等信息。

设备转发报文时，根据报文目的 MAC 地址查询 MAC 地址表，查询到后直接根据出接口转发该报文，如果没找到将采用广播方式在所属 VLAN 内所有出接口转发该报文。

- 动态表项：接口通过报文源 MAC 地址学习，可老化，系统复位后清空。
- 静态表项：用户配置后表项不可老化，系统复位后也不会丢失。
- 黑洞表项：用户配置黑洞 MAC 地址后，源 MAC 地址或目的 MAC 地址是黑洞 MAC 地址的报文会被丢弃。

| MAC地址        | VLAN ID/VSI名称 | 出接口  |
| -------------- | --------------- | ------- |
| 00e0-fc22-0034 | 10              | GE0/0/1 |

### MAC 地址学习和老化

设备收到数据帧时，触发 MAC 地址的学习和刷新。

- 不存在 MAC 地址表项，设备将新收到的源 MAC 地址的接收的接口和 VLAN ID 加入MAC 地址表中。
- 已经存在 MAC 地址表项，设备将重置该表项的老化时间。

设备配置 MAC 表项老化时间后，周期性检查所有动态学习到的 MAC 地址表项。

- 表项命中标志为 1 时，将该表项的命中标记置为 0。
- 表项命令标志为 0 时，表项老化时间到达删除该表项。

MAC 地址表的容量是有限，通过两种方式对 MAC 地址学习进行控制：

- 基于 VLAN 或接口关闭学习 MA C能力：针对某个 VLAN 或接口关闭 MAC 学习能力，对应的动态表项在老化时间之后自动删除，避免攻击报文将整个设备 MAC 表填满。
- 基于 VLAN 或接口进行 MAC 地址数限制：只能学习到指定数目的 MAC 地址表项，达到上限后非 MAC 地址表中的设备发送报文将被丢失。

### MAC 地址漂移

MAC 地址漂移是指设备上一个 VLAN 内有两个端口学习到同一个 MAC 地址，后学习到的 MAC 地址表项覆盖原 MAC 地址表项的现象。

网络中**产生环路**或非法用户进行**网络攻击**都会造成MAC地址发生漂移，导致MAC地址不稳定。

#### MAC 地址漂移检测

利用 MAC 地址出接口跳变现象（设备发送数据存在多个出接口），检测 MAC 地址是否发生漂移。

防止 MAC 地址漂移：

- 提高接口 MAC 地址学习优先级。高优先级接口学到的MAC地址表项可以覆盖低优先级接口学到的MAC地址表项，防止MAC地址在接口间发生漂移。
- 不允许相同优先级的接口发生 MAC 地址表项覆盖。后学习的 MAC 地址表项不会覆盖之前正确学习的表项。

#### MAC 刷新 ARP

MAC 出接口更新时，直接刷新 ARP 表项的出接口，避免 ARP 表项等待老化探测后才会更新出接口，导致不同网段设备的通信中断。

## 以太网交换

普通交换机默认支持二层交换，具备三层路由模块的交换机也可同时支持二层交换和三层交换。

### 二层交换原理

二层交换设备工作在数据链路层，对数据包的转发建立在 MAC 地址基础上，不同接口独立接收发送数据，隔离物理层冲突域。

二层交换设备通过解析和学习以太网帧源 MAC 地址和接口对应关系维护 MAC 地址表，通过目的 MAC 地址查找 MAC 表中向哪个接口转发：

1. 二层交换设备收到以太网帧，将源 MAC 地址和接收接口写入 MAC 表，如果有相同表项就更新老化时间。
2. 判断目的 MAC 地址是否为广播地址：
   1. 广播地址向除了接收接口外其他所有接口转发。
   2. 不是广播地址查找 MAC 表，匹配到表项向对应出接口发送，否则向所有接口转发。

### 三层交换原理

三层交换的核心是用**硬件实现路由转发**，使用三层转发引擎（ASIC 芯片）和硬件转发表（TCAM 表）匹配 IP 地址，无需路由器通过软件遍历路由表。

1. 首次收到数据包后，三层转发表中没有表项，需要上送给 CPU 查询路由表，确定出接口、出口 VLAN 和 MAC 地址后将转发信息写入三层转发表。
2. 后续数据包通过三层转发表匹配源 IP 地址和目的 IP 地址，直接找到对应的出接口和目标 MAC 地址，通过二层转发通道发送。

