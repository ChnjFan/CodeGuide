# UDP 协议

UDP（User Datagram Protocol）用户数据报协议是一种**无连接、不可靠**的传输层网络协议，为网络应用提供轻量级数据传输能力。

[TOC]

## 协议报文

UDP 报文仅包含固定的 8 字节头部和可变长的数据部分。

```bash
 0      7 8     15 16    23 24    31
+--------+--------+--------+--------+
|     Source      |   Destination   |
|      Port       |      Port       |
+--------+--------+--------+--------+
|     Length      |    Checksum     |
+--------+--------+--------+--------+
|          data octets ...
+---------------- ...
```

- 源端口（2 字节）：如果不要求接收端回复数据可以置为 0。
- 目的端口（2 字节）：标识接收端的应用程序（DNS 默认 53 号端口）。
- UDP 长度（2 字节）：UDP 数据报的总长度（头部+数据），最小是 8，最大 65535。
  - UDP 允许发送带 0 字节数据的数据报，不常见。
- 校验和（2字节）：校验数据传输过程中是否损坏，值为 0 时不校验。

校验和包含 UDP 头部、数据部分和一个伪头部，计算时有两点需要注意：

1. UDP 数据报长度可以是奇数个，校验和算法只相加 16 位字（偶数个字节），如果是奇数长度会在末尾追加 0 来填充。
2. 计算时包含 IPv4 12 字节的伪头部或 IPv6 40 字节的伪头部。

```bash
 0      7 8     15 16    23 24    31
+--------+--------+--------+--------+
|          source address           |
+--------+--------+--------+--------+
|        destination address        |
+--------+--------+--------+--------+
|  zero  |protocol|   UDP length    |
+--------+--------+--------+--------+
```

## 核心特征

UDP 所有特性都围绕简化流程、提升速度而设计：

- **无连接**：不需要像 TCP 那样建立 “三次握手” 连接，发送方想发就发，接收方随时接收，流程极简化。
- **不可靠**：不保证数据一定能送达，也不保证数据的传输顺序。
- **无拥塞控制**：不管网络是否拥堵，UDP 都会按原速率持续发送数据，不会主动降低发送速度，避免了因拥塞控制导致的延迟增加。
- **开销小**：UDP 头部结构简单，头部总长度仅 8 字节，对网络带宽的占用更少。

UDP 与 TCP 的关键差异：

| 对比维度 | UDP 协议                    | TCP 协议                     |
| -------- | --------------------------- | ---------------------------- |
| 连接方式 | 无连接                      | 面向连接（三次握手建立）     |
| 可靠性   | 不可靠（不保证送达 / 顺序） | 可靠（保证送达、按序交付）   |
| 拥塞控制 | 无                          | 有（网络拥堵时降低速率）     |
| 头部开销 | 小（8 字节）                | 大（20-60 字节）             |
| 适用场景 | 实时、低延迟场景            | 可靠、有序场景               |
| 典型应用 | 直播、游戏、DNS、广播报文   | 文件下载、网页浏览、聊天记录 |

### 应用场景

正因为 “快” 和 “开销小” 的特点，UDP 被广泛用于对延迟敏感、能容忍少量数据丢失的场景：

- **实时音视频**：如视频通话、直播、语音聊天（如微信语音 / 视频、Zoom 会议）。这类场景中，1-2 帧数据丢失不会影响整体体验，但延迟过高会导致 “卡顿” 或 “不同步”，UDP 的低延迟特性至关重要。
- **实时游戏**：如王者荣耀、英雄联盟等在线游戏。游戏需要实时同步玩家操作（如走位、放技能），延迟超过 100ms 就会影响手感，UDP 能最大限度降低传输延迟，少量数据丢失可通过游戏自身算法弥补（如预测玩家下一步操作）。
- **广播 / 组播**：如局域网内的设备发现（如打印机搜索）、实时数据推送（如股票行情更新）。UDP 支持一对多、多对多通信，无需为每个接收方单独建立连接，效率极高。
- **简单数据传输**：如 DNS 域名解析。DNS 请求数据量小（通常只有几十字节），且对速度要求高，用 UDP 能快速完成查询，即使偶尔失败，客户端重新发送一次即可。