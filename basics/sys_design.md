---
icon: markdown
---

# 系统设计

> 系统设计是一项复杂且关键的任务，旨在创建高效、可靠且易维护的系统，很多大厂除了代码面试外，系统设计也是技术面试中的关键环节，学习如何设计可扩展性的系统将有助于你成一个优秀的工程师。
>
> 网络中关于系统设计原则的资源多如牛毛，本文通过整合收集资源，结合面试实践，帮助你学习如何构建可扩展性的系统。

## 介绍

什么是系统设计？简单来说，系统设计就是为了满足程序需求，设计出系统计算和存储等组件，确保各个组件之间能够协同工作，实现预期的功能和性能。

在软件开发中，系统设计通常包括：

1. 架构设计：确定系统的整体结构，包括各个模块的划分和相互关系。
2. 模块设计：对系统中的各个模块进行详细设计，明确其功能、接口和数据流。
3. 接口设计：设计模块之间以及系统与外部系统之间的交互方式，确保数据传输的正确性和安全性。
4. 数据设计：规划系统所需的数据结构和数据库设计，以支持高效的数据存储和访问。

随着业务的不断扩大，系统的需求和访问量也会随之不断增加。一个好的系统设计除了能有效满足当前的业务需求，也要适应未来的变化，确保系统高效运行。

## 一般性原则

如果你不熟悉系统设计，首先要对一般性原则有一个基本的认识。

### 可扩展性

假设你的网站突然变得很受欢迎，随着点击量的增加，你的网站服务器开始出现内存不足，CPU 利用率持续冲高，或者磁盘空间不足，此时应该如何扩展你的网站来支持更多用户来请求网站资源？

可扩展性就是系统在面对不断增长的工作负载或需求时，通过添加资源来维持或提升系统性能和功能的能力。

在计算机系统架构中，垂直扩展（Vertical Scaling）和水平扩展（Horizontal Scaling）是两种常见的扩展方式。

**垂直扩展**

对于本节开始的问题，最明显的解决方式就是增加内存、CPU 和磁盘空间容量，**垂直扩展就是在不修改应用程序或架构的情况下，只对现有服务器进行升级来提升其处理能力**。

垂直扩展在小规模系统中更具性价比，但随着规模不断扩大，硬件升级存在物理限制，无法无限制地提升性能。而且依赖单一服务器，如果服务器出现故障可能导致系统不可用。

**水平扩展**

**水平扩展是通过增加更多的服务器节点，将负载分散到多个机器上来提高系统的处理能力**。多个节点分担负载，某个节点故障不会影响系统的运行，还可以根据需求动态增加或减少节点，灵活应对业务变化。

系统支持水平扩展，需要设计负载均衡、数据一致性和分布式管理机制，这无疑增加了系统的复杂度。在多个节点之间保持数据一致性，也会带来额外的网络和存储开销。

所以选择垂直扩展还是水平扩展，取决于具体业务需求的规模、预算、技术架构和预期的系统负载。

**负载均衡**

水平扩展多个服务节点后，用户请求应该由哪个节点来处理？

负载均衡器就是将负载（用户请求）均匀分配到系统服务器上。例如，用户在与系统进行交互过程中，服务器 2 可能会在第一个请求中提供服务，然后服务器 9 为用户第二个请求提供服务。

### 延迟与吞吐量

- **延迟**是执行操作或运算结果花费的时间。
- **吞吐量**是单位时间内执行此操作或运算的数量。

通常，系统设计以可接受延迟下最大化吞吐量为目标。

### 可用性与一致性

#### CAP 理论

![CAP理论](./CAP-overview.png)

CAP 理论提出，在分布式系统中，只能同时满足下列的两点：

- 一致性：每次访问都能获得最新数据，但可能会收到错误响应。
- 可用性：每次访问都能收到正确响应，但获取到的数据不一定是最新数据。
- 分区容错性：任意分区网络故障的情况下系统仍能继续运行。

网络并不总是可靠的，在分布式系统中任意时刻都可能发生网络错误，所以系统通常支持分区容错性。那么根据 CAP 理论，系统设计时需要在一致性和可用性中进行权衡。

1. CP：一致性和分区容错性。等待分区节点的响应可能会导致延时错误，如果业务需求需要原子读写，可以选择 CP。
2. AP：可用性和分区容错性。响应分区节点上的可用数据，数据可能不是最新的。如果业务需求允许最终一致性，或外部故障时要求系统继续运行，可以选择 AP。

#### 一致性模式

在 CAP 理论中一致性的定义——每次访问都能获取到最新数据，但可能会收到错误响应。系统在处理并发操作时，如何保证数据的正确性和同步性，常见的一致性模式如下：

**弱一致性**

数据写入操作执行后，可能系统还没有写入数据库，此时访问可能看不到写入数据，尽力优化让用户能访问最新数据。

弱一致性一般应用在 VoIP、视频聊天和实时多人游戏等系统中，例如在通话中网络异常导致丢失数据，重新连接后无法收到丢失的数据内容。

**最终一致性**

数据写入操作执行后，系统各节点可能短时间存在不一致的状态，如果没有新的数据更新，所有数据副本最终都会收敛到统一状态。

在分布式缓存系统（NoSQL 或 CDN）通常采用最终一致性提高响应速度和可扩展性，允许缓存在短时间不同步，但最终同步至最新状态。DNS 系统在域名解析时可能会短暂不一致，但最终解析结果都会一致。

最终一致性的应用场景中，系统更关注高可用性和容错性，对数据立即一致性要求不是特别高。通过异步复制、版本控制和冲突解决机制实现，牺牲部分实时的一致性保证，提供更好的性能和可扩展性。

**强一致性**

数据写入操作执行后，访问数据能立刻可见，无论客户端访问哪个节点获取数据，系统都要表现得像只有一个单一副本数据，确保数据的准确性和实时性。

在文件系统和关系型数据库，金融转账支付等系统中使用强一致性，确保准确的数据实时更新显示。

## 设计实践



## 参考资料

1. [donnemartin/system-design-primer: Learn how to design large-scale systems. Prep for the system design interview. Includes Anki flashcards.](https://github.com/donnemartin/system-design-primer)
2. [CS75 (Summer 2012) Lecture 9 Scalability Harvard Web Development David Malan](https://www.youtube.com/watch?v=-W9F__D3oY4)
3. [Le Cloud Blog](https://web.archive.org/web/20221030091841/http://www.lecloud.net/tagged/scalability/chrono)
4. [CAP Theorem: Revisited](https://robertgreiner.com/cap-theorem-revisited/)
